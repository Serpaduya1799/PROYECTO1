<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal Azuay</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    
    <!-- Esri Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/esri-leaflet/3.0.10/esri-leaflet.min.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
        }

        .sidebar {
            width: 300px;
            background: #2c3e50;
            color: white;
            padding: 20px;
            overflow-y: auto;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
        }

        .sidebar h1 {
            font-size: 24px;
            margin-bottom: 30px;
            text-align: center;
            border-bottom: 2px solid #3498db;
            padding-bottom: 10px;
        }

        .section {
            margin-bottom: 25px;
        }

        .section h3 {
            color: #3498db;
            margin-bottom: 15px;
            font-size: 16px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .layer-control {
            margin-bottom: 10px;
        }

        .layer-control label {
            display: flex;
            align-items: center;
            cursor: pointer;
            padding: 8px;
            border-radius: 5px;
            transition: background-color 0.3s;
        }

        .layer-control label:hover {
            background-color: #34495e;
        }

        .layer-control input[type="checkbox"] {
            margin-right: 10px;
            transform: scale(1.2);
        }

        .btn {
            width: 100%;
            padding: 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .btn:hover {
            background: #2980b9;
        }

        .btn.active {
            background: #e74c3c;
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #3498db;
        }

        .modal-header h2 {
            color: #2c3e50;
            margin: 0;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: #e74c3c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #2c3e50;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #3498db;
        }

        .coordinate-display {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            border-left: 4px solid #3498db;
        }

        .coordinate-display h4 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .coord-info {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            font-family: monospace;
            font-size: 12px;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .error {
            color: #e74c3c;
            background: #ffebee;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .success {
            color: #27ae60;
            background: #e8f5e8;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-connected {
            background-color: #27ae60;
        }

        .status-disconnected {
            background-color: #e74c3c;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <h1>üó∫Ô∏è Geoportal Azuay</h1>
            
            <div class="section">
                <h3>üîå Conexi√≥n</h3>
                <div style="display: flex; align-items: center; margin-bottom: 15px;">
                    <span class="status-indicator" id="connectionStatus"></span>
                    <span id="connectionText">Conectando...</span>
                </div>
            </div>

            <div class="section">
                <h3>üóÇÔ∏è Capas</h3>
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-cantones" checked>
                        Cantones del Azuay
                    </label>
                </div>
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-parroquias" checked>
                        Parroquias Azuay
                    </label>
                </div>
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-edificios">
                        Edificios
                    </label>
                </div>
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-vias">
                        V√≠as Cuenca
                    </label>
                </div>
                <div class="layer-control">
                    <label>
                        <input type="checkbox" id="layer-usos">
                        Usos de Suelo
                    </label>
                </div>
            </div>

            <div class="section">
                <h3>üìä Herramientas</h3>
                <button class="btn" id="btnIngresarDatos">
                    üìç Ingresar Datos Geot√©cnicos
                </button>
                <button class="btn" id="btnVerDatos">
                    üìã Ver Datos Existentes
                </button>
            </div>

            <div class="section">
                <h3>‚ÑπÔ∏è Informaci√≥n</h3>
                <p style="font-size: 12px; line-height: 1.4; color: #bdc3c7;">
                    Haga clic en "Ingresar Datos" y luego seleccione un punto en el mapa para agregar informaci√≥n geot√©cnica.
                </p>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <!-- Modal para ingresar datos -->
    <div id="dataModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>üìç Ingresar Datos Geot√©cnicos</h2>
                <span class="close">&times;</span>
            </div>
            
            <div id="modalContent">
                <div class="coordinate-display">
                    <h4>üìç Coordenadas del Punto</h4>
                    <div class="coord-info">
                        <div><strong>Latitud:</strong> <span id="coordLat">-</span></div>
                        <div><strong>Longitud:</strong> <span id="coordLng">-</span></div>
                        <div><strong>UTM X:</strong> <span id="coordUtmX">-</span></div>
                        <div><strong>UTM Y:</strong> <span id="coordUtmY">-</span></div>
                    </div>
                </div>

                <form id="geoDataForm">
                    <div class="form-group">
                        <label for="tipoSuelo">Tipo de Suelo (SUCS):</label>
                        <select id="tipoSuelo" required>
                            <option value="">Seleccione...</option>
                            <option value="GW">GW - Grava bien graduada</option>
                            <option value="GP">GP - Grava mal graduada</option>
                            <option value="GM">GM - Grava limosa</option>
                            <option value="GC">GC - Grava arcillosa</option>
                            <option value="SW">SW - Arena bien graduada</option>
                            <option value="SP">SP - Arena mal graduada</option>
                            <option value="SM">SM - Arena limosa</option>
                            <option value="SC">SC - Arena arcillosa</option>
                            <option value="ML">ML - Limo de baja plasticidad</option>
                            <option value="CL">CL - Arcilla de baja plasticidad</option>
                            <option value="OL">OL - Limo org√°nico</option>
                            <option value="MH">MH - Limo de alta plasticidad</option>
                            <option value="CH">CH - Arcilla de alta plasticidad</option>
                            <option value="OH">OH - Arcilla org√°nica</option>
                            <option value="PT">PT - Turba</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="indicePlasticidad">√çndice de Plasticidad (%):</label>
                        <input type="number" id="indicePlasticidad" step="0.1" min="0" max="100">
                    </div>

                    <div class="form-group">
                        <label for="nivelFreatico">Nivel Fre√°tico (m):</label>
                        <input type="number" id="nivelFreatico" step="0.1" min="0">
                    </div>

                    <div class="form-group">
                        <label for="provincia">Provincia:</label>
                        <select id="provincia" required>
                            <option value="">Seleccione...</option>
                            <option value="Azuay">Azuay</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="canton">Cant√≥n:</label>
                        <select id="canton" required>
                            <option value="">Seleccione primero la provincia...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="parroquia">Parroquia:</label>
                        <select id="parroquia" required>
                            <option value="">Seleccione primero el cant√≥n...</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="observaciones">Observaciones:</label>
                        <textarea id="observaciones" rows="3" placeholder="Informaci√≥n adicional (opcional)"></textarea>
                    </div>

                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button type="submit" class="btn" style="flex: 1;">üíæ Guardar Datos</button>
                        <button type="button" class="btn" id="cancelBtn" style="flex: 1; background: #95a5a6;">‚ùå Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <!-- Supabase JS -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.39.3/umd.min.js"></script>
    
    <!-- Proj4 para conversi√≥n de coordenadas -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4/2.9.0/proj4.min.js"></script>

    <script>
        // Configuraci√≥n de Supabase
        const SUPABASE_URL = 'https://xgywnwvvrtfoltkcxfgc.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneXdud3Z2cnRmb2x0a2N4ZmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2OTUzMTIsImV4cCI6MjA2ODI3MTMxMn0.RNrfIZsgGwZJ8cnKmF26u0kKtoA7n3HAMjda1Wd-EmY';
        const MAPBOX_TOKEN = 'pk.eyJ1Ijoic2VycGFkdXlhMTciLCJhIjoiY21kZjc1czgwMGFlajJucHVubDgxb3h6biJ9.rvGIyz4jXxeT9kKE6_5J9Q';

        // Inicializar Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // Configuraci√≥n de proyecciones
        proj4.defs('EPSG:32717', '+proj=utm +zone=17 +south +datum=WGS84 +units=m +no_defs');
        const utmProj = 'EPSG:32717';
        const wgsProj = 'EPSG:4326';

        // Variables globales
        let map;
        let currentLayers = {};
        let isAddingData = false;
        let currentMarker = null;
        let selectedCoords = null;

        // Datos para los selectores
        const cantonesAzuay = [
            'Cuenca', 'Gir√≥n', 'Gualaceo', 'Nab√≥n', 'Paute', 'Pucar√°', 'San Fernando',
            'Santa Isabel', 'Sigsig', 'O√±a', 'Chordeleg', 'El Pan', 'Sevilla de Oro', 'Guachapala', 'Camilo Ponce Enr√≠quez'
        ];

        const parroquiasData = {
            'Cuenca': ['Cuenca', 'Ba√±os', 'Cumbe', 'Chaucha', 'Molleturo', 'Nulti', 'Octavio Cordero Palacios', 'Paccha', 'Quingeo', 'Ricaurte', 'San Joaqu√≠n', 'Santa Ana', 'Sayaus√≠', 'Sidcay', 'Sinincay', 'Tarqui', 'Turi', 'Valle', 'Victoria del Portete'],
            'Gir√≥n': ['Gir√≥n', 'Asunci√≥n', 'San Gerardo'],
            'Gualaceo': ['Gualaceo', 'Chordeleg', 'Jad√°n', 'Remigio Crespo Toral', 'San Juan', 'Zhidmad'],
            'Nab√≥n': ['Nab√≥n', 'Cochapata', 'La Paz', 'Las Nieves']
            // Agregar m√°s parroquias seg√∫n sea necesario
        };

        // Inicializaci√≥n
        document.addEventListener('DOMContentLoaded', function() {
            initializeMap();
            initializeEventListeners();
            testConnection();
            setupFormHandlers();
        });

        function initializeMap() {
            // Crear el mapa centrado en Cuenca, Ecuador
            map = L.map('map').setView([-2.9001, -79.0059], 10);

            // Capa base de Mapbox
            L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, {
                attribution: '¬© Mapbox ¬© OpenStreetMap',
                tileSize: 512,
                zoomOffset: -1
            }).addTo(map);

            // Cargar capas iniciales
            loadLayers();

            // Evento de clic en el mapa para agregar datos
            map.on('click', function(e) {
                if (isAddingData) {
                    addDataPoint(e.latlng);
                }
            });
        }

        function initializeEventListeners() {
            // Controles de capas
            document.querySelectorAll('.layer-control input[type="checkbox"]').forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    const layerId = this.id.replace('layer-', '');
                    toggleLayer(layerId, this.checked);
                });
            });

            // Botones
            document.getElementById('btnIngresarDatos').addEventListener('click', toggleDataEntry);
            document.getElementById('btnVerDatos').addEventListener('click', showExistingData);

            // Modal
            document.getElementsByClassName('close')[0].addEventListener('click', closeModal);
            document.getElementById('cancelBtn').addEventListener('click', closeModal);
            
            window.addEventListener('click', function(event) {
                const modal = document.getElementById('dataModal');
                if (event.target === modal) {
                    closeModal();
                }
            });
        }

        async function testConnection() {
            const statusIndicator = document.getElementById('connectionStatus');
            const statusText = document.getElementById('connectionText');
            
            try {
                const { data, error } = await supabase.from('spatial_ref_sys').select('*').limit(1);
                
                if (error) {
                    throw error;
                }
                
                statusIndicator.className = 'status-indicator status-connected';
                statusText.textContent = 'Conectado a Supabase';
                console.log('Conexi√≥n exitosa a Supabase');
            } catch (error) {
                statusIndicator.className = 'status-indicator status-disconnected';
                statusText.textContent = 'Error de conexi√≥n';
                console.error('Error de conexi√≥n:', error);
            }
        }

        async function loadLayers() {
            try {
                // Cargar cantones
                await loadLayer('CANTONESDELAZUAY', 'cantones', '#e74c3c', 2);
                
                // Cargar parroquias
                await loadLayer('parroquiasazuay', 'parroquias', '#3498db', 1);
                
            } catch (error) {
                console.error('Error cargando capas:', error);
            }
        }

        async function loadLayer(tableName, layerKey, color, weight) {
            try {
                const { data, error } = await supabase
                    .from(tableName)
                    .select('*');

                if (error) {
                    throw error;
                }

                if (data && data.length > 0) {
                    // Crear grupo de capas
                    const layerGroup = L.layerGroup();
                    
                    data.forEach(feature => {
                        if (feature.geom) {
                            try {
                                const geoJson = JSON.parse(feature.geom);
                                const layer = L.geoJSON(geoJson, {
                                    style: {
                                        color: color,
                                        weight: weight,
                                        fillOpacity: 0.1
                                    },
                                    onEachFeature: (feature, layer) => {
                                        // Agregar popup con informaci√≥n
                                        let popupContent = `<strong>${tableName}</strong><br>`;
                                        Object.keys(feature.properties || {}).forEach(key => {
                                            if (key !== 'geom') {
                                                popupContent += `${key}: ${feature.properties[key]}<br>`;
                                            }
                                        });
                                        layer.bindPopup(popupContent);
                                    }
                                });
                                layerGroup.addLayer(layer);
                            } catch (parseError) {
                                console.error('Error parseando geometr√≠a:', parseError);
                            }
                        }
                    });

                    currentLayers[layerKey] = layerGroup;
                    
                    // Agregar al mapa si est√° marcado como visible
                    const checkbox = document.getElementById(`layer-${layerKey}`);
                    if (checkbox && checkbox.checked) {
                        layerGroup.addTo(map);
                    }
                }
            } catch (error) {
                console.error(`Error cargando capa ${tableName}:`, error);
            }
        }

        function toggleLayer(layerId, visible) {
            const layer = currentLayers[layerId];
            if (layer) {
                if (visible) {
                    layer.addTo(map);
                } else {
                    map.removeLayer(layer);
                }
            }
        }

        function toggleDataEntry() {
            const btn = document.getElementById('btnIngresarDatos');
            isAddingData = !isAddingData;
            
            if (isAddingData) {
                btn.classList.add('active');
                btn.textContent = '‚ùå Cancelar Ingreso';
                map.getContainer().style.cursor = 'crosshair';
            } else {
                btn.classList.remove('active');
                btn.textContent = 'üìç Ingresar Datos Geot√©cnicos';
                map.getContainer().style.cursor = '';
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                    currentMarker = null;
                }
            }
        }

        function addDataPoint(latlng) {
            selectedCoords = latlng;
            
            // Remover marcador anterior si existe
            if (currentMarker) {
                map.removeLayer(currentMarker);
            }
            
            // Agregar nuevo marcador
            currentMarker = L.marker([latlng.lat, latlng.lng], {
                icon: L.icon({
                    iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDOC4xMzQgMiA1IDUuMTM0IDUgOUM1IDEyLjY2NyAxMiAyMiAxMiAyMkMxMiAyMiAxOSAxMi42NjcgMTkgOUMxOSA1LjEzNCAxNS44NjYgMiAxMiAyWiIgZmlsbD0iIzM0OThkYiIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iOSIgcj0iMyIgZmlsbD0id2hpdGUiLz4KPC9zdmc+',
                    iconSize: [24, 24],
                    iconAnchor: [12, 24]
                })
            }).addTo(map);
            
            // Convertir coordenadas a UTM
            const utmCoords = proj4(wgsProj, utmProj, [latlng.lng, latlng.lat]);
            
            // Mostrar modal con coordenadas
            showDataModal(latlng, utmCoords);
        }

        function showDataModal(latlng, utmCoords) {
            document.getElementById('coordLat').textContent = latlng.lat.toFixed(6);
            document.getElementById('coordLng').textContent = latlng.lng.toFixed(6);
            document.getElementById('coordUtmX').textContent = utmCoords[0].toFixed(2);
            document.getElementById('coordUtmY').textContent = utmCoords[1].toFixed(2);
            
            // Llenar selectores
            fillLocationSelectors();
            
            document.getElementById('dataModal').style.display = 'block';
        }

        function fillLocationSelectors() {
            const provinciaSelect = document.getElementById('provincia');
            const cantonSelect = document.getElementById('canton');
            const parroquiaSelect = document.getElementById('parroquia');
            
            // Limpiar selectores
            cantonSelect.innerHTML = '<option value="">Seleccione primero la provincia...</option>';
            parroquiaSelect.innerHTML = '<option value="">Seleccione primero el cant√≥n...</option>';
            
            // Llenar cantones cuando se seleccione provincia
            provinciaSelect.onchange = function() {
                if (this.value === 'Azuay') {
                    cantonSelect.innerHTML = '<option value="">Seleccione...</option>';
                    cantonesAzuay.forEach(canton => {
                        const option = document.createElement('option');
                        option.value = canton;
                        option.textContent = canton;
                        cantonSelect.appendChild(option);
                    });
                    cantonSelect.disabled = false;
                }
            };
            
            // Llenar parroquias cuando se seleccione cant√≥n
            cantonSelect.onchange = function() {
                const selectedCanton = this.value;
                parroquiaSelect.innerHTML = '<option value="">Seleccione...</option>';
                
                if (parroquiasData[selectedCanton]) {
                    parroquiasData[selectedCanton].forEach(parroquia => {
                        const option = document.createElement('option');
                        option.value = parroquia;
                        option.textContent = parroquia;
                        parroquiaSelect.appendChild(option);
                    });
                    parroquiaSelect.disabled = false;
                }
            };
        }

        function setupFormHandlers() {
            document.getElementById('geoDataForm').onsubmit = async function(e) {
                e.preventDefault();
                await saveGeoData();
            };
        }

        async function saveGeoData() {
            if (!selectedCoords) {
                alert('Error: No hay coordenadas seleccionadas');
                return;
            }
            
            try {
                const formData = {
                    latitud: selectedCoords.lat,
                    longitud: selectedCoords.lng,
                    utm_x: proj4(wgsProj, utmProj, [selectedCoords.lng, selectedCoords.lat])[0],
                    utm_y: proj4(wgsProj, utmProj, [selectedCoords.lng, selectedCoords.lat])[1],
                    tipo_suelo_sucs: document.getElementById('tipoSuelo').value,
                    indice_plasticidad: parseFloat(document.getElementById('indicePlasticidad').value) || null,
                    nivel_freatico: parseFloat(document.getElementById('nivelFreatico').value) || null,
                    provincia: document.getElementById('provincia').value,
                    canton: document.getElementById('canton').value,
                    parroquia: document.getElementById('parroquia').value,
                    observaciones: document.getElementById('observaciones').value || null,
                    fecha_registro: new Date().toISOString()
                };

                // Crear tabla si no existe y guardar datos
                const { data, error } = await supabase
                    .from('datos_geotecnicos')
                    .insert([formData]);

                if (error) {
                    // Si la tabla no existe, intentar crearla
                    if (error.code === '42P01') {
                        await createGeoDataTable();
                        // Intentar insertar nuevamente
                        const { data: retryData, error: retryError } = await supabase
                            .from('datos_geotecnicos')
                            .insert([formData]);
                        
                        if (retryError) {
                            throw retryError;
                        }
                    } else {
                        throw error;
                    }
                }

                alert('‚úÖ Datos guardados exitosamente');
                closeModal();
                resetForm();
                
            } catch (error) {
                console.error('Error guardando datos:', error);
                alert('‚ùå Error al guardar los datos: ' + error.message);
            }
        }

        async function createGeoDataTable() {
            try {
                // Crear la tabla usando SQL directo
                const { data, error } = await supabase.rpc('exec_sql', {
                    sql: `
                        CREATE TABLE IF NOT EXISTS datos_geotecnicos (
                            id SERIAL PRIMARY KEY,
                            latitud DOUBLE PRECISION NOT NULL,
                            longitud DOUBLE PRECISION NOT NULL,
                            utm_x DOUBLE PRECISION,
                            utm_y DOUBLE PRECISION,
                            tipo_suelo_sucs VARCHAR(10),
                            indice_plasticidad DECIMAL(5,2),
                            nivel_freatico DECIMAL(10,2),
                            provincia VARCHAR(50),
                            canton VARCHAR(50),
                            parroquia VARCHAR(100),
                            observaciones TEXT,
                            fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                            geom GEOMETRY(POINT, 4326)
                        );
                        
                        CREATE INDEX IF NOT EXISTS idx_datos_geotecnicos_geom 
                        ON datos_geotecnicos USING GIST (geom);
                    `
                });

                if (error) {
                    console.error('Error creando tabla:', error);
                }
            } catch (error) {
                console.error('Error en createGeoDataTable:', error);
            }
        }

        function closeModal() {
            document.getElementById('dataModal').style.display = 'none';
            resetForm();
            
            // Limpiar marcador si existe
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }
            
            // Desactivar modo de ingreso de datos
            if (isAddingData) {
                toggleDataEntry();
            }
            
            selectedCoords = null;
        }

        function resetForm() {
            document.getElementById('geoDataForm').reset();
            document.getElementById('canton').innerHTML = '<option value="">Seleccione primero la provincia...</option>';
            document.getElementById('parroquia').innerHTML = '<option value="">Seleccione primero el cant√≥n...</option>';
        }

        async function showExistingData() {
            try {
                const { data, error } = await supabase
                    .from('datos_geotecnicos')
                    .select('*')
                    .order('fecha_registro', { ascending: false });

                if (error) {
                    throw error;
                }

                if (data && data.length > 0) {
                    // Crear marcadores para los datos existentes
                    data.forEach(punto => {
                        const marker = L.marker([punto.latitud, punto.longitud], {
                            icon: L.icon({
                                iconUrl: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJDOC4xMzQgMiA1IDUuMTM0IDUgOUM1IDEyLjY2NyAxMiAyMiAxMiAyMkMxMiAyMiAxOSAxMi42NjcgMTkgOUMxOSA1LjEzNCAxNS44NjYgMiAxMiAyWiIgZmlsbD0iIzI3YWU2MCIgc3Ryb2tlPSJ3aGl0ZSIgc3Ryb2tlLXdpZHRoPSIyIi8+CjxjaXJjbGUgY3g9IjEyIiBjeT0iOSIgcj0iMyIgZmlsbD0id2hpdGUiLz4KPC9zdmc+',
                                iconSize: [20, 20],
                                iconAnchor: [10, 20]
                            })
                        });

                        // Crear popup con informaci√≥n
                        const popupContent = `
                            <div style="max-width: 300px;">
                                <h4 style="margin: 0 0 10px 0; color: #2c3e50;">üìä Datos Geot√©cnicos</h4>
                                <p><strong>üó∫Ô∏è Ubicaci√≥n:</strong><br>
                                ${punto.provincia} ‚Üí ${punto.canton} ‚Üí ${punto.parroquia}</p>
                                
                                <p><strong>üìç Coordenadas:</strong><br>
                                Lat: ${punto.latitud?.toFixed(6)}<br>
                                Lng: ${punto.longitud?.toFixed(6)}<br>
                                UTM X: ${punto.utm_x?.toFixed(2)}<br>
                                UTM Y: ${punto.utm_y?.toFixed(2)}</p>
                                
                                <p><strong>üèóÔ∏è Tipo de Suelo:</strong> ${punto.tipo_suelo_sucs || 'N/A'}</p>
                                <p><strong>üìà √çndice Plasticidad:</strong> ${punto.indice_plasticidad ? punto.indice_plasticidad + '%' : 'N/A'}</p>
                                <p><strong>üíß Nivel Fre√°tico:</strong> ${punto.nivel_freatico ? punto.nivel_freatico + ' m' : 'N/A'}</p>
                                
                                ${punto.observaciones ? `<p><strong>üìù Observaciones:</strong><br>${punto.observaciones}</p>` : ''}
                                
                                <p style="font-size: 0.9em; color: #7f8c8d;"><strong>üìÖ Fecha:</strong> ${new Date(punto.fecha_registro).toLocaleDateString('es-ES')}</p>
                            </div>
                        `;

                        marker.bindPopup(popupContent);
                        marker.addTo(map);
                    });

                    alert(`‚úÖ Se cargaron ${data.length} puntos de datos geot√©cnicos en el mapa`);
                } else {
                    alert('‚ÑπÔ∏è No se encontraron datos geot√©cnicos existentes');
                }

            } catch (error) {
                console.error('Error cargando datos existentes:', error);
                alert('‚ùå Error al cargar datos existentes: ' + error.message);
            }
        }

        // Funci√≥n para cargar capas adicionales bajo demanda
        async function loadAdditionalLayer(tableName, layerKey) {
            if (currentLayers[layerKey]) {
                return; // Ya est√° cargada
            }

            try {
                const { data, error } = await supabase
                    .from(tableName)
                    .select('*');

                if (error) {
                    throw error;
                }

                if (data && data.length > 0) {
                    const layerGroup = L.layerGroup();
                    
                    data.forEach(feature => {
                        if (feature.geom) {
                            try {
                                const geoJson = JSON.parse(feature.geom);
                                const layer = L.geoJSON(geoJson, {
                                    style: getLayerStyle(layerKey),
                                    onEachFeature: (feature, layer) => {
                                        let popupContent = `<strong>${tableName}</strong><br>`;
                                        Object.keys(feature.properties || {}).forEach(key => {
                                            if (key !== 'geom') {
                                                popupContent += `${key}: ${feature.properties[key]}<br>`;
                                            }
                                        });
                                        layer.bindPopup(popupContent);
                                    }
                                });
                                layerGroup.addLayer(layer);
                            } catch (parseError) {
                                console.error('Error parseando geometr√≠a:', parseError);
                            }
                        }
                    });

                    currentLayers[layerKey] = layerGroup;
                }
            } catch (error) {
                console.error(`Error cargando capa ${tableName}:`, error);
            }
        }

        function getLayerStyle(layerKey) {
            const styles = {
                'edificios': { color: '#f39c12', weight: 1, fillOpacity: 0.3 },
                'vias': { color: '#9b59b6', weight: 3, fillOpacity: 0 },
                'usos': { color: '#1abc9c', weight: 1, fillOpacity: 0.2 }
            };
            return styles[layerKey] || { color: '#34495e', weight: 1, fillOpacity: 0.1 };
        }

        // Manejar carga de capas adicionales
        document.getElementById('layer-edificios').addEventListener('change', async function() {
            if (this.checked && !currentLayers['edificios']) {
                await loadAdditionalLayer('edificios', 'edificios');
            }
            toggleLayer('edificios', this.checked);
        });

        document.getElementById('layer-vias').addEventListener('change', async function() {
            if (this.checked && !currentLayers['vias']) {
                await loadAdditionalLayer('vias cuenca', 'vias');
            }
            toggleLayer('vias', this.checked);
        });

        document.getElementById('layer-usos').addEventListener('change', async function() {
            if (this.checked && !currentLayers['usos']) {
                await loadAdditionalLayer('usos de suelo', 'usos');
            }
            toggleLayer('usos', this.checked);
        });

        // Funci√≥n para centrar el mapa en una ubicaci√≥n espec√≠fica
        function centerMap(lat, lng, zoom = 15) {
            map.setView([lat, lng], zoom);
        }

        // Funci√≥n para limpiar todos los marcadores de datos
        function clearDataMarkers() {
            map.eachLayer(function(layer) {
                if (layer instanceof L.Marker && 
                    layer.options.icon && 
                    layer.options.icon.options.iconUrl.includes('27ae60')) {
                    map.removeLayer(layer);
                }
            });
        }

        // Agregar bot√≥n para limpiar marcadores
        const clearBtn = document.createElement('button');
        clearBtn.className = 'btn';
        clearBtn.textContent = 'üßπ Limpiar Marcadores';
        clearBtn.style.background = '#95a5a6';
        clearBtn.onclick = clearDataMarkers;
        document.querySelector('.section:last-child').appendChild(clearBtn);

        console.log('üó∫Ô∏è Geoportal Azuay inicializado correctamente');
        console.log('üìä Sistema de datos geot√©cnicos activo');
        console.log('üîó Conectado a Supabase y Mapbox');
    </script>
</body>
</html>
