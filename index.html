<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal Azuay</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; }
        .sidebar { width: 300px; background: #2c3e50; color: white; padding: 20px; overflow-y: auto; }
        .sidebar h1 { margin-bottom: 20px; font-size: 18px; text-align: center; }
        .section { margin-bottom: 20px; }
        .section h3 { color: #3498db; margin-bottom: 10px; font-size: 14px; }
        .btn { width: 100%; padding: 10px; margin: 5px 0; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #2980b9; }
        .btn.active { background: #e74c3c; }
        .layer-item { margin: 5px 0; }
        .layer-item label { display: flex; align-items: center; cursor: pointer; }
        .layer-item input { margin-right: 8px; }
        #map { flex: 1; }
        .status { padding: 8px; margin: 10px 0; border-radius: 4px; font-size: 12px; }
        .status.success { background: #27ae60; }
        .status.error { background: #e74c3c; }
        .status.warning { background: #f39c12; }
        
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .close:hover { color: black; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        .coord-info { background: #f0f0f0; padding: 10px; border-radius: 5px; margin: 10px 0; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1>üó∫Ô∏è Geoportal Azuay</h1>
        
        <div class="section">
            <h3>üîå Estado</h3>
            <div id="status" class="status warning">Iniciando...</div>
        </div>

        <div class="section">
            <h3>üóÇÔ∏è Capas</h3>
            <div class="layer-item">
                <label><input type="checkbox" id="layer-cantones" checked> Cantones</label>
            </div>
            <div class="layer-item">
                <label><input type="checkbox" id="layer-parroquias" checked> Parroquias</label>
            </div>
            <div class="layer-item">
                <label><input type="checkbox" id="layer-edificios"> Edificios</label>
            </div>
            <div class="layer-item">
                <label><input type="checkbox" id="layer-vias"> V√≠as</label>
            </div>
            <div class="layer-item">
                <label><input type="checkbox" id="layer-usos"> Usos de Suelo</label>
            </div>
        </div>

        <div class="section">
            <h3>üìä Herramientas</h3>
            <button class="btn" id="btnAddData">üìç Ingresar Datos</button>
            <button class="btn" id="btnShowData">üìã Ver Datos</button>
            <button class="btn" id="btnClear">üßπ Limpiar</button>
        </div>
    </div>

    <div id="map"></div>

    <div id="dataModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>üìç Datos Geot√©cnicos</h2>
            
            <div class="coord-info">
                <strong>Coordenadas:</strong><br>
                Lat: <span id="coordLat">-</span>, Lng: <span id="coordLng">-</span><br>
                UTM X: <span id="coordUtmX">-</span>, UTM Y: <span id="coordUtmY">-</span>
            </div>

            <form id="geoForm">
                <div class="form-group">
                    <label>Tipo de Suelo (SUCS):</label>
                    <select id="tipoSuelo" required>
                        <option value="">Seleccione...</option>
                        <option value="GW">GW - Grava bien graduada</option>
                        <option value="GP">GP - Grava mal graduada</option>
                        <option value="GM">GM - Grava limosa</option>
                        <option value="GC">GC - Grava arcillosa</option>
                        <option value="SW">SW - Arena bien graduada</option>
                        <option value="SP">SP - Arena mal graduada</option>
                        <option value="SM">SM - Arena limosa</option>
                        <option value="SC">SC - Arena arcillosa</option>
                        <option value="ML">ML - Limo baja plasticidad</option>
                        <option value="CL">CL - Arcilla baja plasticidad</option>
                        <option value="MH">MH - Limo alta plasticidad</option>
                        <option value="CH">CH - Arcilla alta plasticidad</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>√çndice de Plasticidad (%):</label>
                    <input type="number" id="plasticidad" step="0.1" min="0" max="100">
                </div>

                <div class="form-group">
                    <label>Nivel Fre√°tico (m):</label>
                    <input type="number" id="freatico" step="0.1" min="0">
                </div>

                <div class="form-group">
                    <label>Provincia:</label>
                    <select id="provincia" required>
                        <option value="">Seleccione...</option>
                        <option value="Azuay">Azuay</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Cant√≥n:</label>
                    <select id="canton" required>
                        <option value="">Primero seleccione provincia...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Parroquia:</label>
                    <select id="parroquia" required>
                        <option value="">Primero seleccione cant√≥n...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Observaciones:</label>
                    <textarea id="observaciones" rows="3"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="btn">üíæ Guardar</button>
                    <button type="button" class="btn" id="cancelBtn" style="background: #95a5a6;">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // Configuraci√≥n
        const SUPABASE_URL = 'https://xgywnwvvrtfoltkcxfgc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneXdud3Z2cnRmb2x0a2N4ZmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2OTUzMTIsImV4cCI6MjA2ODI3MTMxMn0.RNrfIZsgGwZJ8cnKmF26u0kKtoA7n3HAMjda1Wd-EmY';
        const MAPBOX_TOKEN = 'pk.eyJ1Ijoic2VycGFkdXlhMTciLCJhIjoiY21kZjc1czgwMGFlajJucHVubDgxb3h6biJ9.rvGIyz4jXxeT9kKE6_5J9Q';

        // Variables
        let map, supabase;
        let isAddingData = false;
        let currentMarker = null;
        let selectedCoords = null;
        let layers = {};
        let dataMarkers = [];

        // Datos para selectores
        const cantones = ['Cuenca', 'Gir√≥n', 'Gualaceo', 'Nab√≥n', 'Paute', 'Pucar√°', 'San Fernando', 'Santa Isabel', 'Sigsig', 'O√±a', 'Chordeleg', 'El Pan', 'Sevilla de Oro', 'Guachapala', 'Camilo Ponce Enr√≠quez'];
        
        const parroquias = {
            'Cuenca': ['Cuenca', 'Ba√±os', 'Cumbe', 'Chaucha', 'Molleturo', 'Nulti', 'Paccha', 'Quingeo', 'Ricaurte', 'San Joaqu√≠n', 'Santa Ana', 'Sayaus√≠', 'Sidcay', 'Sinincay', 'Tarqui', 'Turi', 'Valle'],
            'Gir√≥n': ['Gir√≥n', 'Asunci√≥n', 'San Gerardo'],
            'Gualaceo': ['Gualaceo', 'Chordeleg', 'Jad√°n', 'San Juan'],
            'Nab√≥n': ['Nab√≥n', 'Cochapata', 'La Paz'],
            'Paute': ['Paute', 'Bul√°n', 'Chic√°n', 'El Cabo'],
            'Santa Isabel': ['Santa Isabel', 'Abd√≥n Calder√≥n', 'El Carmen de Pijil√≠'],
            'Sigsig': ['Sigsig', 'Cuchil', 'Gima', 'Ludo'],
            'Chordeleg': ['Chordeleg', 'Delegate', 'La Uni√≥n']
        };

        // Conversi√≥n UTM simple para Ecuador (Zona 17S)
        function toUTM(lat, lng) {
            const x = Math.round((lng + 81) * 111320 * Math.cos(lat * Math.PI / 180) + 500000);
            const y = Math.round(Math.abs(lat * 110540) + 10000000);
            return { x, y };
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            console.log('Iniciando geoportal...');
            updateStatus('Iniciando...', 'warning');
            
            initSupabase();
            initMap();
            initEvents();
            loadLayers();
        }

        function initSupabase() {
            try {
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                updateStatus('Conectado a Supabase', 'success');
                console.log('Supabase OK');
            } catch (error) {
                updateStatus('Error Supabase: ' + error.message, 'error');
                console.error('Error Supabase:', error);
            }
        }

        function initMap() {
            try {
                map = L.map('map').setView([-2.9001, -79.0059], 10);
                
                // Mapa base
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap'
                }).addTo(map);

                // Mapa satelital
                const satellite = L.tileLayer(`https://api.mapbox.com/styles/v1/mapbox/satellite-v9/tiles/{z}/{x}/{y}?access_token=${MAPBOX_TOKEN}`, {
                    attribution: '¬© Mapbox'
                });

                // Control de capas
                L.control.layers(
                    { 'Mapa': map._layers[Object.keys(map._layers)[0]], 'Sat√©lite': satellite },
                    {}
                ).addTo(map);

                map.on('click', onMapClick);
                updateStatus('Mapa listo', 'success');
                console.log('Mapa OK');
            } catch (error) {
                updateStatus('Error mapa: ' + error.message, 'error');
                console.error('Error mapa:', error);
            }
        }

        function initEvents() {
            document.getElementById('btnAddData').onclick = toggleAddData;
            document.getElementById('btnShowData').onclick = showData;
            document.getElementById('btnClear').onclick = clearMarkers;
            
            document.querySelector('.close').onclick = closeModal;
            document.getElementById('cancelBtn').onclick = closeModal;
            document.getElementById('geoForm').onsubmit = saveData;
            
            // Selectores de ubicaci√≥n
            document.getElementById('provincia').onchange = function() {
                const canton = document.getElementById('canton');
                const parroquia = document.getElementById('parroquia');
                
                canton.innerHTML = '<option value="">Seleccione cant√≥n...</option>';
                parroquia.innerHTML = '<option value="">Seleccione parroquia...</option>';
                
                if (this.value === 'Azuay') {
                    cantones.forEach(c => {
                        canton.innerHTML += `<option value="${c}">${c}</option>`;
                    });
                }
            };
            
            document.getElementById('canton').onchange = function() {
                const parroquia = document.getElementById('parroquia');
                parroquia.innerHTML = '<option value="">Seleccione parroquia...</option>';
                
                if (parroquias[this.value]) {
                    parroquias[this.value].forEach(p => {
                        parroquia.innerHTML += `<option value="${p}">${p}</option>`;
                    });
                }
            };

            // Controles de capas
            document.querySelectorAll('input[id^="layer-"]').forEach(cb => {
                cb.onchange = function() {
                    const layerName = this.id.replace('layer-', '');
                    if (this.checked) {
                        loadLayer(layerName);
                    } else {
                        removeLayer(layerName);
                    }
                };
            });

            // Cerrar modal con clic fuera
            window.onclick = function(event) {
                if (event.target === document.getElementById('dataModal')) {
                    closeModal();
                }
            };
        }

        async function loadLayers() {
            // Cargar capas principales al inicio
            loadLayer('cantones');
            loadLayer('parroquias');
        }

        async function loadLayer(layerName) {
            if (layers[layerName]) return;
            
            const tableMap = {
                'cantones': 'CANTONESDELAZUAY',
                'parroquias': 'parroquiasazuay',
                'edificios': 'edificios',
                'vias': 'vias cuenca',
                'usos': 'usos de suelo'
            };
            
            const tableName = tableMap[layerName];
            if (!tableName) return;
            
            try {
                updateStatus(`Cargando ${layerName}...`, 'warning');
                
                const { data, error } = await supabase.from(tableName).select('*');
                
                if (error) throw error;
                
                if (data && data.length > 0) {
                    const layerGroup = L.layerGroup();
                    
                    data.forEach(item => {
                        // Buscar campo de geometr√≠a
                        let geomField = null;
                        for (const key in item) {
                            if (key.toLowerCase().includes('geom')) {
                                geomField = key;
                                break;
                            }
                        }
                        
                        if (geomField && item[geomField]) {
                            try {
                                const geom = typeof item[geomField] === 'string' 
                                    ? JSON.parse(item[geomField]) 
                                    : item[geomField];
                                
                                const layer = L.geoJSON(geom, {
                                    style: getLayerStyle(layerName)
                                });
                                
                                layer.bindPopup(`<strong>${tableName}</strong><br>${JSON.stringify(item, null, 2).slice(0, 200)}...`);
                                layerGroup.addLayer(layer);
                            } catch (e) {
                                console.warn('Error parseando geometr√≠a:', e);
                            }
                        }
                    });
                    
                    layers[layerName] = layerGroup;
                    layerGroup.addTo(map);
                    updateStatus(`${layerName} cargado (${data.length} elementos)`, 'success');
                } else {
                    updateStatus(`${layerName}: sin datos`, 'warning');
                }
                
            } catch (error) {
                console.error(`Error cargando ${layerName}:`, error);
                updateStatus(`Error en ${layerName}: ${error.message}`, 'error');
            }
        }

        function removeLayer(layerName) {
            if (layers[layerName]) {
                map.removeLayer(layers[layerName]);
                delete layers[layerName];
            }
        }

        function getLayerStyle(layerName) {
            const styles = {
                'cantones': { color: '#e74c3c', weight: 2, fillOpacity: 0.1 },
                'parroquias': { color: '#3498db', weight: 1, fillOpacity: 0.1 },
                'edificios': { color: '#f39c12', weight: 1, fillOpacity: 0.3 },
                'vias': { color: '#9b59b6', weight: 3, fillOpacity: 0 },
                'usos': { color: '#1abc9c', weight: 1, fillOpacity: 0.2 }
            };
            return styles[layerName] || { color: '#34495e', weight: 1, fillOpacity: 0.1 };
        }

        function toggleAddData() {
            isAddingData = !isAddingData;
            const btn = document.getElementById('btnAddData');
            
            if (isAddingData) {
                btn.textContent = '‚ùå Cancelar';
                btn.classList.add('active');
                map.getContainer().style.cursor = 'crosshair';
                updateStatus('Haz clic en el mapa para agregar punto', 'warning');
            } else {
                btn.textContent = 'üìç Ingresar Datos';
                btn.classList.remove('active');
                map.getContainer().style.cursor = '';
                updateStatus('Modo agregar desactivado', 'success');
                if (currentMarker) {
                    map.removeLayer(currentMarker);
                    currentMarker = null;
                }
            }
        }

        function onMapClick(e) {
            if (!isAddingData) return;
            
            selectedCoords = e.latlng;
            
            if (currentMarker) map.removeLayer(currentMarker);
            
            currentMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
            
            const utm = toUTM(e.latlng.lat, e.latlng.lng);
            
            document.getElementById('coordLat').textContent = e.latlng.lat.toFixed(6);
            document.getElementById('coordLng').textContent = e.latlng.lng.toFixed(6);
            document.getElementById('coordUtmX').textContent = utm.x;
            document.getElementById('coordUtmY').textContent = utm.y;
            
            document.getElementById('dataModal').style.display = 'block';
        }

        async function saveData(e) {
            e.preventDefault();
            
            if (!selectedCoords) {
                alert('No hay coordenadas seleccionadas');
                return;
            }
            
            try {
                updateStatus('Guardando...', 'warning');
                
                const utm = toUTM(selectedCoords.lat, selectedCoords.lng);
                
                const data = {
                    latitud: selectedCoords.lat,
                    longitud: selectedCoords.lng,
                    utm_x: utm.x,
                    utm_y: utm.y,
                    tipo_suelo_sucs: document.getElementById('tipoSuelo').value,
                    indice_plasticidad: parseFloat(document.getElementById('plasticidad').value) || null,
                    nivel_freatico: parseFloat(document.getElementById('freatico').value) || null,
                    provincia: document.getElementById('provincia').value,
                    canton: document.getElementById('canton').value,
                    parroquia: document.getElementById('parroquia').value,
                    observaciones: document.getElementById('observaciones').value || null,
                    fecha_registro: new Date().toISOString()
                };
                
                const { error } = await supabase.from('datos_geotecnicos').insert([data]);
                
                if (error) {
                    if (error.code === '42P01') {
                        alert('Tabla no existe. Cr√©ala en pgAdmin con:\n\nCREATE TABLE datos_geotecnicos (\n  id SERIAL PRIMARY KEY,\n  latitud DOUBLE PRECISION,\n  longitud DOUBLE PRECISION,\n  utm_x INTEGER,\n  utm_y INTEGER,\n  tipo_suelo_sucs VARCHAR(10),\n  indice_plasticidad DECIMAL(5,2),\n  nivel_freatico DECIMAL(10,2),\n  provincia VARCHAR(50),\n  canton VARCHAR(50),\n  parroquia VARCHAR(100),\n  observaciones TEXT,\n  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);');
                        updateStatus('Tabla no existe', 'error');
                        return;
                    }
                    throw error;
                }
                
                updateStatus('Datos guardados', 'success');
                alert('Datos guardados exitosamente');
                closeModal();
                
            } catch (error) {
                console.error('Error guardando:', error);
                updateStatus('Error: ' + error.message, 'error');
                alert('Error guardando: ' + error.message);
            }
        }

        async function showData() {
            try {
                updateStatus('Cargando datos...', 'warning');
                
                const { data, error } = await supabase
                    .from('datos_geotecnicos')
                    .select('*')
                    .order('fecha_registro', { ascending: false });
                
                if (error) {
                    if (error.code === '42P01') {
                        alert('No hay tabla de datos a√∫n');
                        updateStatus('Tabla no existe', 'warning');
                        return;
                    }
                    throw error;
                }
                
                clearMarkers();
                
                if (data && data.length > 0) {
                    data.forEach((punto, i) => {
                        const marker = L.marker([punto.latitud, punto.longitud])
                            .bindPopup(`
                                <div style="max-width: 250px;">
                                    <h4>Punto ${i + 1}</h4>
                                    <p><strong>Suelo:</strong> ${punto.tipo_suelo_sucs || 'N/A'}</p>
                                    <p><strong>Plasticidad:</strong> ${punto.indice_plasticidad || 'N/A'}%</p>
                                    <p><strong>Fre√°tico:</strong> ${punto.nivel_freatico || 'N/A'} m</p>
                                    <p><strong>Ubicaci√≥n:</strong> ${punto.canton}, ${punto.provincia}</p>
                                    <p><strong>Fecha:</strong> ${new Date(punto.fecha_registro).toLocaleDateString()}</p>
                                    ${punto.observaciones ? `<p><strong>Obs:</strong> ${punto.observaciones}</p>` : ''}
                                </div>
                            `)
                            .addTo(map);
                        
                        dataMarkers.push(marker);
                    });
                    
                    updateStatus(`${data.length} puntos cargados`, 'success');
                    alert(`Se cargaron ${data.length} puntos`);
                } else {
                    updateStatus('No hay datos', 'warning');
                    alert('No hay datos guardados');
                }
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                updateStatus('Error: ' + error.message, 'error');
                alert('Error: ' + error.message);
            }
        }

        function clearMarkers() {
            dataMarkers.forEach(marker => map.removeLayer(marker));
            dataMarkers = [];
            updateStatus('Marcadores eliminados', 'success');
        }

        function closeModal() {
            document.getElementById('dataModal').style.display = 'none';
            document.getElementById('geoForm').reset();
            
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }
            
            if (isAddingData) toggleAddData();
            selectedCoords = null;
        }

        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        console.log('Geoportal cargado');
    </script>
</body>
</html>
