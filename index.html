<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Geoportal Azuay</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
        body { margin: 0; font-family: Arial, sans-serif; display: flex; height: 100vh; }
        .sidebar { width: 300px; background: #2c3e50; color: white; padding: 20px; overflow-y: auto; }
        #map { flex: 1; height: 100vh; }
        .btn { width: 100%; padding: 10px; margin: 5px 0; background: #3498db; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .btn:hover { background: #2980b9; }
        .btn.active { background: #e74c3c; }
        .status { padding: 8px; margin: 10px 0; border-radius: 4px; font-size: 12px; }
        .status.success { background: #27ae60; }
        .status.error { background: #e74c3c; }
        .status.warning { background: #f39c12; }
        .modal { display: none; position: fixed; z-index: 9999; left: 0; top: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); }
        .modal-content { background: white; margin: 5% auto; padding: 20px; border-radius: 8px; width: 80%; max-width: 500px; max-height: 80vh; overflow-y: auto; }
        .close { color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; }
        .form-group { margin: 15px 0; }
        .form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
        .form-group input, .form-group select, .form-group textarea { width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1>üó∫Ô∏è Geoportal Azuay</h1>
        <div id="status" class="status warning">Iniciando...</div>
        
        <h3>üóÇÔ∏è Capas</h3>
        <div style="margin: 10px 0;">
            <label style="display: flex; align-items: center; margin: 5px 0; cursor: pointer;">
                <input type="checkbox" id="layer-cantones" checked style="margin-right: 8px;">
                Cantones del Azuay
            </label>
            <label style="display: flex; align-items: center; margin: 5px 0; cursor: pointer;">
                <input type="checkbox" id="layer-parroquias" checked style="margin-right: 8px;">
                Parroquias Azuay
            </label>
            <label style="display: flex; align-items: center; margin: 5px 0; cursor: pointer;">
                <input type="checkbox" id="layer-edificios" style="margin-right: 8px;">
                Edificios
            </label>
            <label style="display: flex; align-items: center; margin: 5px 0; cursor: pointer;">
                <input type="checkbox" id="layer-vias" style="margin-right: 8px;">
                V√≠as Cuenca
            </label>
            <label style="display: flex; align-items: center; margin: 5px 0; cursor: pointer;">
                <input type="checkbox" id="layer-usos" style="margin-right: 8px;">
                Usos de Suelo
            </label>
        </div>
        
        <h3>üìä Herramientas</h3>
        <button class="btn" id="btnAddData">üìç Ingresar Datos</button>
        <button class="btn" id="btnShowData">üìã Ver Datos</button>
        <button class="btn" id="btnClear">üßπ Limpiar</button>
    </div>
    
    <div id="map"></div>

    <div id="dataModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>üìç Datos Geot√©cnicos</h2>
            
            <div style="background: #f0f0f0; padding: 10px; border-radius: 5px; margin: 10px 0;">
                <strong>Coordenadas:</strong><br>
                Lat: <span id="coordLat">-</span>, Lng: <span id="coordLng">-</span><br>
                UTM X: <span id="coordUtmX">-</span>, UTM Y: <span id="coordUtmY">-</span>
            </div>

            <form id="geoForm">
                <div class="form-group">
                    <label>Nombre del T√©cnico:</label>
                    <input type="text" id="nombreTecnico" required>
                </div>
                
                <div class="form-group">
                    <label>Tipo de Suelo (SUCS):</label>
                    <select id="tipoSuelo" required>
                        <option value="">Seleccione...</option>
                        <option value="GW">GW - Grava bien graduada</option>
                        <option value="GP">GP - Grava mal graduada</option>
                        <option value="SW">SW - Arena bien graduada</option>
                        <option value="SP">SP - Arena mal graduada</option>
                        <option value="ML">ML - Limo baja plasticidad</option>
                        <option value="CL">CL - Arcilla baja plasticidad</option>
                        <option value="MH">MH - Limo alta plasticidad</option>
                        <option value="CH">CH - Arcilla alta plasticidad</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Profundidad de Muestra (m):</label>
                    <input type="number" id="profundidad" step="0.1" min="0" required>
                </div>

                <div class="form-group">
                    <label>Radio de Influencia (m):</label>
                    <select id="radioBuffer" required>
                        <option value="">Seleccione...</option>
                        <option value="50">50m</option>
                        <option value="100">100m</option>
                        <option value="200">200m</option>
                        <option value="500">500m</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>√çndice de Plasticidad (%):</label>
                    <input type="number" id="plasticidad" step="0.1" min="0" max="100">
                </div>

                <div class="form-group">
                    <label>Nivel Fre√°tico (m):</label>
                    <input type="number" id="freatico" step="0.1" min="0">
                </div>

                <div class="form-group">
                    <label>Provincia:</label>
                    <input type="text" id="provincia" value="Azuay" readonly style="background: #f0f0f0;">
                </div>

                <div class="form-group">
                    <label>Cant√≥n:</label>
                    <input type="text" id="canton" readonly style="background: #f0f0f0;">
                </div>

                <div class="form-group">
                    <label>Parroquia:</label>
                    <input type="text" id="parroquia" readonly style="background: #f0f0f0;">
                </div>

                <div class="form-group">
                    <label>Observaciones:</label>
                    <textarea id="observaciones" rows="3"></textarea>
                </div>

                <button type="submit" class="btn">üíæ Guardar</button>
                <button type="button" class="btn" id="cancelBtn" style="background: #95a5a6;">‚ùå Cancelar</button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        const SUPABASE_URL = 'https://xgywnwvvrtfoltkcxfgc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneXdud3Z2cnRmb2x0a2N4ZmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2OTUzMTIsImV4cCI6MjA2ODI3MTMxMn0.RNrfIZsgGwZJ8cnKmF26u0kKtoA7n3HAMjda1Wd-EmY';

        let map, supabase;
        let isAddingData = false;
        let currentMarker = null;
        let currentBuffer = null;
        let selectedCoords = null;
        let dataMarkers = [];
        let layers = {};

        function toUTM(lat, lng) {
            const x = Math.round((lng + 81) * 111320 * Math.cos(lat * Math.PI / 180) + 500000);
            const y = Math.round(Math.abs(lat * 110540) + 10000000);
            return { x, y };
        }

        function updateStatus(message, type) {
            document.getElementById('status').textContent = message;
            document.getElementById('status').className = `status ${type}`;
        }

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus('Iniciando...', 'warning');
            
            // Supabase
            supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
            
            // Mapa
            map = L.map('map').setView([-2.9001, -79.0059], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap'
            }).addTo(map);
            
            updateStatus('Sistema listo', 'success');
            
            // Cargar capas autom√°ticamente
            loadLayer('cantones');
            loadLayer('parroquias');
            
            // Eventos
            document.getElementById('btnAddData').onclick = toggleAddData;
            document.getElementById('btnShowData').onclick = showData;
            document.getElementById('btnClear').onclick = clearMarkers;
            document.querySelector('.close').onclick = closeModal;
            document.getElementById('cancelBtn').onclick = closeModal;
            document.getElementById('geoForm').onsubmit = saveData;
            document.getElementById('radioBuffer').onchange = createBuffer;
            
            // Eventos de capas
            document.querySelectorAll('input[id^="layer-"]').forEach(cb => {
                cb.onchange = function() {
                    const layerName = this.id.replace('layer-', '');
                    if (this.checked) {
                        loadLayer(layerName);
                    } else {
                        removeLayer(layerName);
                    }
                };
            });
            
            map.on('click', onMapClick);
        });

        async function loadLayer(layerName) {
            if (layers[layerName]) return;
            
            const tableNames = {
                'cantones': 'CANTONESDELAZUAY',
                'parroquias': 'parroquiasazuay',
                'edificios': 'edificios',
                'vias': 'vias cuenca',
                'usos': 'usos de suelo'
            };
            
            const tableName = tableNames[layerName];
            if (!tableName) return;
            
            try {
                updateStatus(`Cargando ${layerName}...`, 'warning');
                
                const { data, error } = await supabase.from(tableName).select('*');
                
                if (error) {
                    console.error(`Error cargando ${tableName}:`, error);
                    updateStatus(`Error en ${layerName}`, 'error');
                    return;
                }
                
                if (data && data.length > 0) {
                    const layerGroup = L.layerGroup();
                    let count = 0;
                    
                    data.forEach(item => {
                        // Buscar campo de geometr√≠a
                        let geomField = null;
                        for (const key in item) {
                            if (key.toLowerCase().includes('geom')) {
                                geomField = key;
                                break;
                            }
                        }
                        
                        if (geomField && item[geomField]) {
                            try {
                                const geom = typeof item[geomField] === 'string' 
                                    ? JSON.parse(item[geomField]) 
                                    : item[geomField];
                                
                                const layer = L.geoJSON(geom, {
                                    style: getLayerStyle(layerName),
                                    onEachFeature: function(feature, layer) {
                                        // Popup con informaci√≥n
                                        let popupContent = `<h4>${tableName}</h4>`;
                                        Object.keys(item).forEach(key => {
                                            if (!key.toLowerCase().includes('geom') && item[key]) {
                                                popupContent += `<p><b>${key}:</b> ${item[key]}</p>`;
                                            }
                                        });
                                        layer.bindPopup(popupContent);
                                    }
                                });
                                
                                layerGroup.addLayer(layer);
                                count++;
                            } catch (e) {
                                console.warn('Error parseando geometr√≠a:', e);
                            }
                        }
                    });
                    
                    if (count > 0) {
                        layers[layerName] = layerGroup;
                        layerGroup.addTo(map);
                        updateStatus(`${layerName} cargado (${count} elementos)`, 'success');
                    } else {
                        updateStatus(`${layerName}: sin geometr√≠as v√°lidas`, 'warning');
                    }
                } else {
                    updateStatus(`${layerName}: sin datos`, 'warning');
                }
                
            } catch (error) {
                console.error(`Error cargando ${layerName}:`, error);
                updateStatus(`Error en ${layerName}: ${error.message}`, 'error');
            }
        }

        function removeLayer(layerName) {
            if (layers[layerName]) {
                map.removeLayer(layers[layerName]);
                delete layers[layerName];
                updateStatus(`${layerName} ocultado`, 'success');
            }
        }

        function getLayerStyle(layerName) {
            const styles = {
                'cantones': { color: '#e74c3c', weight: 2, fillOpacity: 0.1 },
                'parroquias': { color: '#3498db', weight: 1, fillOpacity: 0.1 },
                'edificios': { color: '#f39c12', weight: 1, fillOpacity: 0.3 },
                'vias': { color: '#9b59b6', weight: 3, fillOpacity: 0 },
                'usos': { color: '#1abc9c', weight: 1, fillOpacity: 0.2 }
            };
            return styles[layerName] || { color: '#34495e', weight: 1, fillOpacity: 0.1 };
        }

        async function detectLocation(coords) {
            // Detectar cant√≥n y parroquia basado en las capas cargadas
            let canton = 'Cuenca';  // Default
            let parroquia = 'Por detectar';
            
            // Buscar en qu√© pol√≠gono est√° el punto
            if (layers['cantones']) {
                layers['cantones'].eachLayer(function(layer) {
                    try {
                        if (layer.getBounds && layer.getBounds().contains(coords)) {
                            // Extraer nombre del cant√≥n del popup o propiedades
                            const popupContent = layer.getPopup();
                            if (popupContent) {
                                const content = popupContent.getContent();
                                // Buscar patr√≥n de nombre
                                const match = content.match(/<b>DPA_DESCAN:<\/b>\s*([^<]+)/i) ||
                                            content.match(/<b>CANTON:<\/b>\s*([^<]+)/i) ||
                                            content.match(/<b>NOMBRE:<\/b>\s*([^<]+)/i);
                                if (match) {
                                    canton = match[1].trim();
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('Error detectando cant√≥n:', e);
                    }
                });
            }
            
            if (layers['parroquias']) {
                layers['parroquias'].eachLayer(function(layer) {
                    try {
                        if (layer.getBounds && layer.getBounds().contains(coords)) {
                            const popupContent = layer.getPopup();
                            if (popupContent) {
                                const content = popupContent.getContent();
                                const match = content.match(/<b>DPA_DESPAR:<\/b>\s*([^<]+)/i) ||
                                            content.match(/<b>PARROQUIA:<\/b>\s*([^<]+)/i) ||
                                            content.match(/<b>NOMBRE:<\/b>\s*([^<]+)/i);
                                if (match) {
                                    parroquia = match[1].trim();
                                }
                            }
                        }
                    } catch (e) {
                        console.warn('Error detectando parroquia:', e);
                    }
                });
            }
            
            document.getElementById('canton').value = canton;
            document.getElementById('parroquia').value = parroquia;
        }
        });

        function toggleAddData() {
            isAddingData = !isAddingData;
            const btn = document.getElementById('btnAddData');
            
            if (isAddingData) {
                btn.textContent = '‚ùå Cancelar';
                btn.classList.add('active');
                map.getContainer().style.cursor = 'crosshair';
                updateStatus('Haz clic en el mapa', 'warning');
            } else {
                btn.textContent = 'üìç Ingresar Datos';
                btn.classList.remove('active');
                map.getContainer().style.cursor = '';
                updateStatus('Sistema listo', 'success');
                if (currentMarker) map.removeLayer(currentMarker);
                if (currentBuffer) map.removeLayer(currentBuffer);
            }
        }

        function onMapClick(e) {
            if (!isAddingData) return;
            
            selectedCoords = e.latlng;
            
            if (currentMarker) map.removeLayer(currentMarker);
            if (currentBuffer) map.removeLayer(currentBuffer);
            
            currentMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
            
            const utm = toUTM(e.latlng.lat, e.latlng.lng);
            
            document.getElementById('coordLat').textContent = e.latlng.lat.toFixed(6);
            document.getElementById('coordLng').textContent = e.latlng.lng.toFixed(6);
            document.getElementById('coordUtmX').textContent = utm.x;
            document.getElementById('coordUtmY').textContent = utm.y;
            
            // Auto-detectar ubicaci√≥n usando las capas cargadas
            detectLocation(e.latlng);
            
            document.getElementById('dataModal').style.display = 'block';
        }

        function createBuffer() {
            const radius = document.getElementById('radioBuffer').value;
            if (!radius || !selectedCoords) return;
            
            if (currentBuffer) map.removeLayer(currentBuffer);
            
            currentBuffer = L.circle([selectedCoords.lat, selectedCoords.lng], {
                radius: parseInt(radius),
                color: '#3498db',
                fillColor: '#3498db',
                fillOpacity: 0.2,
                weight: 2
            }).addTo(map);
        }

        async function saveData(e) {
            e.preventDefault();
            
            if (!selectedCoords) {
                alert('No hay coordenadas');
                return;
            }
            
            try {
                updateStatus('Guardando...', 'warning');
                
                const utm = toUTM(selectedCoords.lat, selectedCoords.lng);
                
                const data = {
                    nombre_tecnico: document.getElementById('nombreTecnico').value,
                    latitud: selectedCoords.lat,
                    longitud: selectedCoords.lng,
                    utm_x: utm.x,
                    utm_y: utm.y,
                    tipo_suelo_sucs: document.getElementById('tipoSuelo').value,
                    profundidad_muestra: parseFloat(document.getElementById('profundidad').value),
                    radio_influencia: parseInt(document.getElementById('radioBuffer').value),
                    indice_plasticidad: parseFloat(document.getElementById('plasticidad').value) || null,
                    nivel_freatico: parseFloat(document.getElementById('freatico').value) || null,
                    provincia: 'Azuay',
                    canton: document.getElementById('canton').value,
                    parroquia: document.getElementById('parroquia').value,
                    observaciones: document.getElementById('observaciones').value || null,
                    fecha_registro: new Date().toISOString()
                };
                
                const { error } = await supabase.from('datos_geotecnicos').insert([data]);
                
                if (error) {
                    if (error.code === '42P01') {
                        alert('CREAR TABLA:\n\nCREATE TABLE datos_geotecnicos (\n  id SERIAL PRIMARY KEY,\n  nombre_tecnico VARCHAR(100),\n  latitud DOUBLE PRECISION,\n  longitud DOUBLE PRECISION,\n  utm_x INTEGER,\n  utm_y INTEGER,\n  tipo_suelo_sucs VARCHAR(10),\n  profundidad_muestra DECIMAL(5,2),\n  radio_influencia INTEGER,\n  indice_plasticidad DECIMAL(5,2),\n  nivel_freatico DECIMAL(10,2),\n  provincia VARCHAR(50),\n  canton VARCHAR(50),\n  parroquia VARCHAR(100),\n  observaciones TEXT,\n  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);');
                        return;
                    }
                    throw error;
                }
                
                updateStatus('Guardado exitoso', 'success');
                alert('‚úÖ Datos guardados');
                closeModal();
                
            } catch (error) {
                updateStatus('Error: ' + error.message, 'error');
                alert('Error: ' + error.message);
            }
        }

        async function showData() {
            try {
                updateStatus('Cargando datos...', 'warning');
                
                const { data, error } = await supabase
                    .from('datos_geotecnicos')
                    .select('*')
                    .order('fecha_registro', { ascending: false });
                
                if (error) {
                    if (error.code === '42P01') {
                        alert('No hay tabla de datos');
                        return;
                    }
                    throw error;
                }
                
                clearMarkers();
                
                if (data && data.length > 0) {
                    data.forEach((punto, i) => {
                        const marker = L.marker([punto.latitud, punto.longitud])
                            .bindPopup(`
                                <h4>Punto ${i + 1}</h4>
                                <p><b>T√©cnico:</b> ${punto.nombre_tecnico}</p>
                                <p><b>Suelo:</b> ${punto.tipo_suelo_sucs}</p>
                                <p><b>Profundidad:</b> ${punto.profundidad_muestra}m</p>
                                <p><b>Radio:</b> ${punto.radio_influencia}m</p>
                                <p><b>Ubicaci√≥n:</b> ${punto.canton}</p>
                                <p><b>Fecha:</b> ${new Date(punto.fecha_registro).toLocaleDateString()}</p>
                            `)
                            .addTo(map);
                        
                        dataMarkers.push(marker);
                        
                        if (punto.radio_influencia) {
                            const buffer = L.circle([punto.latitud, punto.longitud], {
                                radius: punto.radio_influencia,
                                color: '#27ae60',
                                fillColor: '#27ae60',
                                fillOpacity: 0.1,
                                weight: 1
                            }).addTo(map);
                            
                            dataMarkers.push(buffer);
                        }
                    });
                    
                    updateStatus(`${data.length} puntos cargados`, 'success');
                    alert(`${data.length} puntos cargados`);
                } else {
                    alert('No hay datos');
                }
                
            } catch (error) {
                updateStatus('Error: ' + error.message, 'error');
                alert('Error: ' + error.message);
            }
        }

        function clearMarkers() {
            dataMarkers.forEach(marker => map.removeLayer(marker));
            dataMarkers = [];
        }

        function closeModal() {
            document.getElementById('dataModal').style.display = 'none';
            document.getElementById('geoForm').reset();
            
            if (currentMarker) map.removeLayer(currentMarker);
            if (currentBuffer) map.removeLayer(currentBuffer);
            if (isAddingData) toggleAddData();
            
            selectedCoords = null;
        }
    </script>
</body>
</html>
