<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geoportal Azuay - T√©cnico</title>
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css' rel='stylesheet' />
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: Arial, sans-serif;
            height: 100vh;
            overflow: hidden;
        }
        
        .header {
            background: #2563eb;
            color: white;
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            font-size: 1.5rem;
            font-weight: bold;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 70px);
        }
        
        .sidebar {
            width: 300px;
            background: white;
            padding: 1rem;
            overflow-y: auto;
            border-right: 1px solid #ccc;
        }
        
        .map-container {
            flex: 1;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .section {
            margin-bottom: 1.5rem;
            padding: 1rem;
            background: #f8f9fa;
            border-radius: 8px;
        }
        
        .section h3 {
            margin-bottom: 1rem;
            color: #333;
        }
        
        .layer-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background: white;
            border-radius: 4px;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }
        
        .form-group select, .form-group input {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .btn {
            width: 100%;
            padding: 0.75rem;
            background: #2563eb;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        
        .btn:hover {
            background: #1d4ed8;
        }
        
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .coordinates {
            position: absolute;
            bottom: 10px;
            left: 10px;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 0.5rem;
            border-radius: 4px;
            font-family: monospace;
        }
        
        .selected-point {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            font-size: 0.9rem;
        }
        
        .message {
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">üó∫Ô∏è Geoportal Azuay</div>
        <div>üîß Modo T√©cnico</div>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <!-- Capas -->
            <div class="section">
                <h3>Capas Disponibles</h3>
                <div class="layer-item">
                    <input type="checkbox" id="cobertura">
                    <label for="cobertura">Cobertura de la Tierra</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="uso-tierra">
                    <label for="uso-tierra">Uso de la Tierra</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="cantones">
                    <label for="cantones">Cantones del Azuay</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="parroquias">
                    <label for="parroquias">Parroquias del Azuay</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="vias">
                    <label for="vias">V√≠as</label>
                </div>
                <div class="layer-item">
                    <input type="checkbox" id="puntos-datos" checked>
                    <label for="puntos-datos">Puntos de Datos</label>
                </div>
            </div>

            <!-- Agregar Punto -->
            <div class="section">
                <h3>üìç Agregar Punto de Datos</h3>
                
                <div id="message" class="message"></div>
                
                <p style="margin-bottom: 1rem; color: #666;">
                    Haz clic en el mapa para seleccionar un punto
                </p>
                
                <div id="selectedPoint" class="selected-point" style="display: none;"></div>
                
                <div class="form-group">
                    <label>Clasificaci√≥n SUCS:</label>
                    <select id="sucsType">
                        <option value="">Seleccionar tipo de suelo</option>
                        <option value="GW">GW - Grava bien graduada</option>
                        <option value="GP">GP - Grava mal graduada</option>
                        <option value="GM">GM - Grava limosa</option>
                        <option value="GC">GC - Grava arcillosa</option>
                        <option value="SW">SW - Arena bien graduada</option>
                        <option value="SP">SP - Arena mal graduada</option>
                        <option value="SM">SM - Arena limosa</option>
                        <option value="SC">SC - Arena arcillosa</option>
                        <option value="ML">ML - Limo de baja plasticidad</option>
                        <option value="CL">CL - Arcilla de baja plasticidad</option>
                        <option value="OL">OL - Limo org√°nico</option>
                        <option value="MH">MH - Limo de alta plasticidad</option>
                        <option value="CH">CH - Arcilla de alta plasticidad</option>
                        <option value="OH">OH - Arcilla org√°nica</option>
                        <option value="PT">PT - Turba</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Nivel Fre√°tico (m):</label>
                    <input type="number" id="nivelFreatico" step="0.1" placeholder="Ej: 2.5">
                </div>
                
                <div class="form-group">
                    <label>Radio del Estrato (m):</label>
                    <select id="radioEstrato">
                        <option value="50">50 metros</option>
                        <option value="100" selected>100 metros</option>
                        <option value="150">150 metros</option>
                        <option value="200">200 metros</option>
                        <option value="250">250 metros</option>
                        <option value="500">500 metros</option>
                    </select>
                </div>
                
                <button class="btn" id="saveBtn" disabled>üíæ Guardar Punto</button>
            </div>
        </div>

        <div class="map-container">
            <div id="map"></div>
            <div class="coordinates" id="coordinates">
                Lat: -2.9001, Lng: -79.0059
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        let map;
        let selectedCoordinates = null;
        
        // Configuraci√≥n
        const MAPBOX_TOKEN = 'pk.eyJ1Ijoic2VycGFkdXlhMTciLCJhIjoiY21kZTM1d3RhMGJjajJscHM0emIzYjVheCJ9.n9I1c8_WHPDSz7_pzU5rwA';
        const SUPABASE_URL = 'https://xgywnwvvrtfoltkcxfgc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneXdud3Z2cnRmb2x0a2N4ZmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2OTUzMTIsImV4cCI6MjA2ODI3MTMxMn0.RNrfIZsgGwZJ8cnKmF26u0kKtoA7n3HAMjda1Wd-EmY';
        
        mapboxgl.accessToken = MAPBOX_TOKEN;

        // Funciones b√°sicas
        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = `message ${type}`;
            msg.style.display = 'block';
            setTimeout(() => {
                msg.style.display = 'none';
            }, 5000);
        }

        function updateSaveButton() {
            const btn = document.getElementById('saveBtn');
            const sucs = document.getElementById('sucsType').value;
            const nivel = document.getElementById('nivelFreatico').value;
            
            btn.disabled = !(selectedCoordinates && sucs && nivel);
        }

        // Crear buffer circular
        function createBuffer(center, radiusMeters) {
            const points = 64;
            const coords = [];
            const earthRadius = 6378137;
            
            for (let i = 0; i < points; i++) {
                const angle = (i * 360) / points;
                const angleRad = (angle * Math.PI) / 180;
                
                const dx = radiusMeters * Math.cos(angleRad);
                const dy = radiusMeters * Math.sin(angleRad);
                
                const deltaLat = dy / earthRadius * (180 / Math.PI);
                const deltaLng = dx / (earthRadius * Math.cos(center[1] * Math.PI / 180)) * (180 / Math.PI);
                
                coords.push([
                    center[0] + deltaLng,
                    center[1] + deltaLat
                ]);
            }
            
            coords.push(coords[0]); // Cerrar pol√≠gono
            
            return {
                type: 'Polygon',
                coordinates: [coords]
            };
        }

        // Mostrar punto temporal
        function showTempPoint(coords) {
            const radio = parseInt(document.getElementById('radioEstrato').value);
            const buffer = createBuffer(coords, radio);
            
            // Remover anterior
            if (map.getSource('temp-point')) {
                map.removeLayer('temp-point');
                map.removeSource('temp-point');
            }
            if (map.getSource('temp-buffer')) {
                map.removeLayer('temp-buffer-fill');
                map.removeLayer('temp-buffer-line');
                map.removeSource('temp-buffer');
            }
            
            // Agregar buffer
            map.addSource('temp-buffer', {
                type: 'geojson',
                data: { type: 'Feature', geometry: buffer }
            });
            
            map.addLayer({
                id: 'temp-buffer-fill',
                type: 'fill',
                source: 'temp-buffer',
                paint: {
                    'fill-color': '#2563eb',
                    'fill-opacity': 0.3
                }
            });
            
            map.addLayer({
                id: 'temp-buffer-line',
                type: 'line',
                source: 'temp-buffer',
                paint: {
                    'line-color': '#2563eb',
                    'line-width': 2,
                    'line-dasharray': [2, 2]
                }
            });
            
            // Agregar punto
            map.addSource('temp-point', {
                type: 'geojson',
                data: {
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: coords
                    }
                }
            });
            
            map.addLayer({
                id: 'temp-point',
                type: 'circle',
                source: 'temp-point',
                paint: {
                    'circle-radius': 8,
                    'circle-color': '#dc2626',
                    'circle-stroke-width': 3,
                    'circle-stroke-color': '#ffffff'
                }
            });
        }

        // Guardar punto
        async function savePoint() {
            if (!selectedCoordinates) {
                showMessage('Selecciona un punto en el mapa', 'error');
                return;
            }
            
            const sucs = document.getElementById('sucsType').value;
            const nivel = document.getElementById('nivelFreatico').value;
            const radio = document.getElementById('radioEstrato').value;
            
            if (!sucs || !nivel) {
                showMessage('Completa todos los campos', 'error');
                return;
            }
            
            try {
                const buffer = createBuffer(selectedCoordinates, parseInt(radio));
                
                const data = {
                    geom: JSON.stringify({
                        type: 'Point',
                        coordinates: selectedCoordinates
                    }),
                    buffer_geom: JSON.stringify(buffer),
                    sucs_type: sucs,
                    nivel_freatico: parseFloat(nivel),
                    radio_estrato: parseInt(radio),
                    fecha_creacion: new Date().toISOString(),
                    usuario_creacion: 'T√©cnico'
                };
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/puntos_datos`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    showMessage('Punto guardado exitosamente', 'success');
                    
                    // Limpiar
                    document.getElementById('sucsType').value = '';
                    document.getElementById('nivelFreatico').value = '';
                    document.getElementById('selectedPoint').style.display = 'none';
                    selectedCoordinates = null;
                    updateSaveButton();
                    
                    // Remover temporal
                    if (map.getSource('temp-point')) {
                        map.removeLayer('temp-point');
                        map.removeSource('temp-point');
                    }
                    if (map.getSource('temp-buffer')) {
                        map.removeLayer('temp-buffer-fill');
                        map.removeLayer('temp-buffer-line');
                        map.removeSource('temp-buffer');
                    }
                    
                    loadPoints();
                } else {
                    showMessage('Error al guardar: ' + response.status, 'error');
                }
            } catch (error) {
                showMessage('Error: ' + error.message, 'error');
            }
        }

        // Cargar puntos existentes
        async function loadPoints() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/puntos_datos?select=*`, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`
                    }
                });
                
                if (!response.ok) return;
                
                const data = await response.json();
                
                if (data.length === 0) return;
                
                const pointFeatures = [];
                const bufferFeatures = [];
                
                data.forEach(point => {
                    try {
                        let pointGeom = typeof point.geom === 'string' ? JSON.parse(point.geom) : point.geom;
                        let bufferGeom = typeof point.buffer_geom === 'string' ? JSON.parse(point.buffer_geom) : point.buffer_geom;
                        
                        if (pointGeom) {
                            pointFeatures.push({
                                type: 'Feature',
                                geometry: pointGeom,
                                properties: {
                                    id: point.id,
                                    sucs_type: point.sucs_type,
                                    nivel_freatico: point.nivel_freatico,
                                    radio_estrato: point.radio_estrato,
                                    fecha_creacion: point.fecha_creacion
                                }
                            });
                        }
                        
                        if (bufferGeom) {
                            bufferFeatures.push({
                                type: 'Feature',
                                geometry: bufferGeom,
                                properties: {
                                    id: point.id,
                                    sucs_type: point.sucs_type
                                }
                            });
                        }
                    } catch (e) {
                        console.warn('Error procesando punto:', e);
                    }
                });
                
                // Agregar buffers
                if (bufferFeatures.length > 0) {
                    if (map.getSource('buffers')) {
                        map.getSource('buffers').setData({
                            type: 'FeatureCollection',
                            features: bufferFeatures
                        });
                    } else {
                        map.addSource('buffers', {
                            type: 'geojson',
                            data: {
                                type: 'FeatureCollection',
                                features: bufferFeatures
                            }
                        });
                        
                        map.addLayer({
                            id: 'buffers-fill',
                            type: 'fill',
                            source: 'buffers',
                            paint: {
                                'fill-color': '#22c55e',
                                'fill-opacity': 0.3
                            }
                        });
                        
                        map.addLayer({
                            id: 'buffers-line',
                            type: 'line',
                            source: 'buffers',
                            paint: {
                                'line-color': '#22c55e',
                                'line-width': 2
                            }
                        });
                    }
                }
                
                // Agregar puntos
                if (pointFeatures.length > 0) {
                    if (map.getSource('points')) {
                        map.getSource('points').setData({
                            type: 'FeatureCollection',
                            features: pointFeatures
                        });
                    } else {
                        map.addSource('points', {
                            type: 'geojson',
                            data: {
                                type: 'FeatureCollection',
                                features: pointFeatures
                            }
                        });
                        
                        map.addLayer({
                            id: 'points',
                            type: 'circle',
                            source: 'points',
                            paint: {
                                'circle-radius': 8,
                                'circle-color': '#ffffff',
                                'circle-stroke-width': 2,
                                'circle-stroke-color': '#000000'
                            }
                        });
                        
                        map.addLayer({
                            id: 'point-labels',
                            type: 'symbol',
                            source: 'points',
                            layout: {
                                'text-field': ['get', 'sucs_type'],
                                'text-size': 12,
                                'text-offset': [0, 2],
                                'text-anchor': 'top'
                            },
                            paint: {
                                'text-color': '#000000',
                                'text-halo-color': '#ffffff',
                                'text-halo-width': 2
                            }
                        });
                        
                        // Click en puntos
                        map.on('click', 'points', (e) => {
                            const props = e.features[0].properties;
                            new mapboxgl.Popup()
                                .setLngLat(e.lngLat)
                                .setHTML(`
                                    <div style="padding: 10px;">
                                        <h4>üìç Punto de Datos</h4>
                                        <p><strong>ID:</strong> ${props.id}</p>
                                        <p><strong>SUCS:</strong> ${props.sucs_type}</p>
                                        <p><strong>Nivel Fre√°tico:</strong> ${props.nivel_freatico} m</p>
                                        <p><strong>Radio:</strong> ${props.radio_estrato} m</p>
                                    </div>
                                `)
                                .addTo(map);
                        });
                        
                        map.on('mouseenter', 'points', () => {
                            map.getCanvas().style.cursor = 'pointer';
                        });
                        
                        map.on('mouseleave', 'points', () => {
                            map.getCanvas().style.cursor = '';
                        });
                    }
                }
                
            } catch (error) {
                console.error('Error cargando puntos:', error);
            }
        }

        // Inicializar mapa
        function initMap() {
            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/satellite-streets-v12',
                center: [-79.0059, -2.9001],
                zoom: 10
            });

            map.on('load', () => {
                console.log('Mapa cargado');
                loadPoints();
                
                map.addControl(new mapboxgl.NavigationControl(), 'top-right');
            });

            // Coordenadas en tiempo real
            map.on('mousemove', (e) => {
                document.getElementById('coordinates').textContent = 
                    `Lat: ${e.lngLat.lat.toFixed(4)}, Lng: ${e.lngLat.lng.toFixed(4)}`;
            });

            // Click para seleccionar punto
            map.on('click', (e) => {
                selectedCoordinates = [e.lngLat.lng, e.lngLat.lat];
                const radio = document.getElementById('radioEstrato').value;
                
                document.getElementById('selectedPoint').innerHTML = `
                    <strong>Punto seleccionado:</strong><br>
                    Lat: ${e.lngLat.lat.toFixed(6)}<br>
                    Lng: ${e.lngLat.lng.toFixed(6)}<br>
                    Radio: ${radio} metros
                `;
                document.getElementById('selectedPoint').style.display = 'block';
                
                showTempPoint(selectedCoordinates);
                updateSaveButton();
            });
        }

        // Configuraci√≥n de capas
        const LAYER_CONFIG = {
            'cobertura': {
                table: 'COBERTURA%20DE%20LA%20TIERRA%20AZUAY',
                color: '#22c55e',
                type: 'fill',
                fields: 'id,geom,descr,niv1,niv2,DPA_DESCAN'
            },
            'uso-tierra': {
                table: 'USO%20DE%20LA%20TIERRA%20AZUAY',
                color: '#f59e0b',
                type: 'fill',
                fields: 'id,geom,descr,cag_desc,pen_desc,DPA_DESCAN'
            },
            'cantones': {
                table: 'CANTONESDELAZUAY',
                color: '#ef4444',
                type: 'line',
                fields: 'id,geom,DPA_DESCAN,DPA_DESPRO'
            },
            'parroquias': {
                table: 'PARROQUIAS%20AZUAY',
                color: '#3b82f6',
                type: 'line',
                fields: 'id,geom,DPA_DESPAR,DPA_DESCAN,DPA_DESPRO'
            },
            'vias': {
                table: 'vias',
                color: '#8b5cf6',
                type: 'line',
                fields: 'id,geom,nombre,tipo,estado'
            }
        };

        // Funci√≥n para cargar capas
        async function loadLayer(layerId) {
            const config = LAYER_CONFIG[layerId];
            if (!config) {
                console.error('Configuraci√≥n de capa no encontrada:', layerId);
                return;
            }

            try {
                console.log(`Cargando capa: ${layerId}`);
                showMessage(`Cargando ${layerId}...`, 'success');

                const url = `${SUPABASE_URL}/rest/v1/${config.table}?select=${config.fields}&limit=50`;
                
                const response = await fetch(url, {
                    headers: {
                        'apikey': SUPABASE_KEY,
                        'Authorization': `Bearer ${SUPABASE_KEY}`,
                        'Content-Type': 'application/json'
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                console.log(`Datos recibidos para ${layerId}:`, data.length, 'registros');

                if (data.length === 0) {
                    showMessage(`No hay datos para ${layerId}`, 'error');
                    return;
                }

                const features = [];
                let processedCount = 0;

                for (const item of data) {
                    try {
                        if (!item.geom) continue;

                        let geometry;
                        if (typeof item.geom === 'string') {
                            geometry = JSON.parse(item.geom);
                        } else {
                            geometry = item.geom;
                        }

                        if (geometry && geometry.type && geometry.coordinates) {
                            features.push({
                                type: 'Feature',
                                geometry: geometry,
                                properties: item
                            });
                            processedCount++;
                        }
                    } catch (error) {
                        console.warn(`Error procesando item ${item.id}:`, error);
                    }
                }

                if (features.length > 0) {
                    addLayerToMap(layerId, features, config);
                    showMessage(`${layerId}: ${features.length} elementos cargados`, 'success');
                } else {
                    showMessage(`No se pudieron procesar geometr√≠as para ${layerId}`, 'error');
                }

            } catch (error) {
                console.error(`Error cargando ${layerId}:`, error);
                showMessage(`Error cargando ${layerId}: ${error.message}`, 'error');
            }
        }

        // Funci√≥n para agregar capa al mapa
        function addLayerToMap(layerId, features, config) {
            const geojson = {
                type: 'FeatureCollection',
                features: features
            };

            // Remover capa si ya existe
            if (map.getSource(layerId)) {
                map.removeLayer(layerId);
                if (map.getLayer(layerId + '-outline')) {
                    map.removeLayer(layerId + '-outline');
                }
                map.removeSource(layerId);
            }

            // Agregar fuente
            map.addSource(layerId, {
                type: 'geojson',
                data: geojson
            });

            if (config.type === 'fill') {
                // Capa de relleno
                map.addLayer({
                    id: layerId,
                    type: 'fill',
                    source: layerId,
                    paint: {
                        'fill-color': config.color,
                        'fill-opacity': 0.3
                    }
                });

                // Contorno
                map.addLayer({
                    id: layerId + '-outline',
                    type: 'line',
                    source: layerId,
                    paint: {
                        'line-color': config.color,
                        'line-width': 1,
                        'line-opacity': 0.8
                    }
                });
            } else {
                // Capa de l√≠neas
                map.addLayer({
                    id: layerId,
                    type: 'line',
                    source: layerId,
                    paint: {
                        'line-color': config.color,
                        'line-width': 2,
                        'line-opacity': 0.8
                    }
                });
            }

            // Eventos de click
            map.on('click', layerId, (e) => {
                const props = e.features[0].properties;
                let content = `<div style="padding: 10px; max-width: 300px;">`;
                
                if (layerId === 'cobertura') {
                    content += `
                        <h4>üåø Cobertura de la Tierra</h4>
                        <p><strong>Descripci√≥n:</strong> ${props.descr || 'N/A'}</p>
                        <p><strong>Nivel 1:</strong> ${props.niv1 || 'N/A'}</p>
                        <p><strong>Nivel 2:</strong> ${props.niv2 || 'N/A'}</p>
                        <p><strong>Cant√≥n:</strong> ${props.DPA_DESCAN || 'N/A'}</p>
                    `;
                } else if (layerId === 'uso-tierra') {
                    content += `
                        <h4>üèûÔ∏è Uso de la Tierra</h4>
                        <p><strong>Descripci√≥n:</strong> ${props.descr || 'N/A'}</p>
                        <p><strong>Categor√≠a:</strong> ${props.cag_desc || 'N/A'}</p>
                        <p><strong>Pendiente:</strong> ${props.pen_desc || 'N/A'}</p>
                        <p><strong>Cant√≥n:</strong> ${props.DPA_DESCAN || 'N/A'}</p>
                    `;
                } else if (layerId === 'cantones') {
                    content += `
                        <h4>üèõÔ∏è Cant√≥n</h4>
                        <p><strong>Cant√≥n:</strong> ${props.DPA_DESCAN || 'N/A'}</p>
                        <p><strong>Provincia:</strong> ${props.DPA_DESPRO || 'N/A'}</p>
                    `;
                } else if (layerId === 'parroquias') {
                    content += `
                        <h4>üèòÔ∏è Parroquia</h4>
                        <p><strong>Parroquia:</strong> ${props.DPA_DESPAR || 'N/A'}</p>
                        <p><strong>Cant√≥n:</strong> ${props.DPA_DESCAN || 'N/A'}</p>
                        <p><strong>Provincia:</strong> ${props.DPA_DESPRO || 'N/A'}</p>
                    `;
                } else if (layerId === 'vias') {
                    content += `
                        <h4>üõ£Ô∏è V√≠a</h4>
                        <p><strong>Nombre:</strong> ${props.nombre || 'N/A'}</p>
                        <p><strong>Tipo:</strong> ${props.tipo || 'N/A'}</p>
                        <p><strong>Estado:</strong> ${props.estado || 'N/A'}</p>
                    `;
                }
                
                content += `<p style="font-size: 0.8em; color: #666; margin-top: 5px;">ID: ${props.id}</p></div>`;

                new mapboxgl.Popup()
                    .setLngLat(e.lngLat)
                    .setHTML(content)
                    .addTo(map);
            });

            map.on('mouseenter', layerId, () => {
                map.getCanvas().style.cursor = 'pointer';
            });

            map.on('mouseleave', layerId, () => {
                map.getCanvas().style.cursor = '';
            });

            console.log(`Capa ${layerId} agregada al mapa`);
        }

        // Funci√≥n para remover capa
        function removeLayer(layerId) {
            if (map.getSource(layerId)) {
                if (map.getLayer(layerId)) {
                    map.removeLayer(layerId);
                }
                if (map.getLayer(layerId + '-outline')) {
                    map.removeLayer(layerId + '-outline');
                }
                map.removeSource(layerId);
                console.log(`Capa ${layerId} removida`);
            }
        }

        // Event listeners
        document.getElementById('saveBtn').addEventListener('click', savePoint);
        document.getElementById('sucsType').addEventListener('change', updateSaveButton);
        document.getElementById('nivelFreatico').addEventListener('input', updateSaveButton);
        
        // Event listeners para las capas
        document.getElementById('cobertura').addEventListener('change', (e) => {
            if (e.target.checked) {
                loadLayer('cobertura');
            } else {
                removeLayer('cobertura');
            }
        });

        document.getElementById('uso-tierra').addEventListener('change', (e) => {
            if (e.target.checked) {
                loadLayer('uso-tierra');
            } else {
                removeLayer('uso-tierra');
            }
        });

        document.getElementById('cantones').addEventListener('change', (e) => {
            if (e.target.checked) {
                loadLayer('cantones');
            } else {
                removeLayer('cantones');
            }
        });

        document.getElementById('parroquias').addEventListener('change', (e) => {
            if (e.target.checked) {
                loadLayer('parroquias');
            } else {
                removeLayer('parroquias');
            }
        });

        document.getElementById('vias').addEventListener('change', (e) => {
            if (e.target.checked) {
                loadLayer('vias');
            } else {
                removeLayer('vias');
            }
        });

        document.getElementById('puntos-datos').addEventListener('change', (e) => {
            if (e.target.checked) {
                loadPoints();
            } else {
                if (map.getSource('points')) {
                    map.removeLayer('points');
                    map.removeLayer('point-labels');
                    map.removeSource('points');
                }
                if (map.getSource('buffers')) {
                    map.removeLayer('buffers-fill');
                    map.removeLayer('buffers-line');
                    map.removeSource('buffers');
                }
            }
        });
        
        // Actualizar buffer cuando cambie radio
        document.getElementById('radioEstrato').addEventListener('change', () => {
            if (selectedCoordinates) {
                const radio = document.getElementById('radioEstrato').value;
                document.getElementById('selectedPoint').innerHTML = `
                    <strong>Punto seleccionado:</strong><br>
                    Lat: ${selectedCoordinates[1].toFixed(6)}<br>
                    Lng: ${selectedCoordinates[0].toFixed(6)}<br>
                    Radio: ${radio} metros
                `;
                showTempPoint(selectedCoordinates);
            }
        });

        // Inicializar cuando el DOM est√© listo
        document.addEventListener('DOMContentLoaded', initMap);
        
        console.log('Aplicaci√≥n inicializada');
    </script>
</body>
</html>
