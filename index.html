<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Geoportal Azuay</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: Arial, sans-serif; height: 100vh; display: flex; }
        .sidebar { 
            width: 320px; 
            background: #2c3e50; 
            color: white; 
            padding: 20px; 
            overflow-y: auto;
            flex-shrink: 0;
        }
        .sidebar h1 { margin-bottom: 20px; font-size: 18px; text-align: center; }
        .section { margin-bottom: 20px; }
        .section h3 { color: #3498db; margin-bottom: 10px; font-size: 14px; }
        #map { 
            flex: 1; 
            width: 100%;
            height: 100vh;
            background: #e8f4fd;
        }
        .btn { 
            width: 100%; 
            padding: 12px; 
            margin: 5px 0; 
            background: #3498db; 
            color: white; 
            border: none; 
            border-radius: 5px; 
            cursor: pointer; 
            font-size: 14px;
        }
        .btn:hover { background: #2980b9; }
        .btn.active { background: #e74c3c; }
        .status { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            font-size: 12px; 
            text-align: center;
        }
        .status.success { background: #27ae60; color: white; }
        .status.error { background: #e74c3c; color: white; }
        .status.warning { background: #f39c12; color: white; }
        .layer-item { 
            margin: 8px 0; 
            display: flex; 
            align-items: center;
        }
        .layer-item input { margin-right: 10px; }
        .layer-item label { cursor: pointer; font-size: 13px; }
        .modal { 
            display: none; 
            position: fixed; 
            z-index: 10000; 
            left: 0; 
            top: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
        }
        .modal-content { 
            background: white; 
            margin: 3% auto; 
            padding: 25px; 
            border-radius: 10px; 
            width: 85%; 
            max-width: 550px; 
            max-height: 85vh; 
            overflow-y: auto; 
        }
        .close { 
            color: #aaa; 
            float: right; 
            font-size: 28px; 
            font-weight: bold; 
            cursor: pointer; 
        }
        .close:hover { color: #000; }
        .form-group { margin: 15px 0; }
        .form-group label { 
            display: block; 
            margin-bottom: 5px; 
            font-weight: bold; 
            color: #2c3e50;
        }
        .form-group input, .form-group select, .form-group textarea { 
            width: 100%; 
            padding: 10px; 
            border: 2px solid #ddd; 
            border-radius: 5px; 
            font-size: 14px;
            box-sizing: border-box; 
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            border-color: #3498db;
            outline: none;
        }
        .coord-info {
            background: #ecf0f1;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
            border-left: 4px solid #3498db;
        }
        .coord-info h4 {
            margin-bottom: 10px;
            color: #2c3e50;
        }
    </style>
</head>
<body>
    <div class="sidebar">
        <h1>üó∫Ô∏è Geoportal Azuay</h1>
        
        <div id="status" class="status warning">Iniciando sistema...</div>
        
        <div class="section">
            <h3>üóÇÔ∏è Capas</h3>
            <div class="layer-item">
                <input type="checkbox" id="layer-cantones" checked>
                <label for="layer-cantones">Cantones del Azuay</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="layer-parroquias" checked>
                <label for="layer-parroquias">Parroquias Azuay</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="layer-edificios">
                <label for="layer-edificios">Edificios</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="layer-vias">
                <label for="layer-vias">V√≠as Cuenca</label>
            </div>
            <div class="layer-item">
                <input type="checkbox" id="layer-usos">
                <label for="layer-usos">Usos de Suelo</label>
            </div>
        </div>
        
        <div class="section">
            <h3>üìä Herramientas</h3>
            <button class="btn" id="btnAddData">üìç Ingresar Datos</button>
            <button class="btn" id="btnShowData">üìã Ver Datos</button>
            <button class="btn" id="btnClear">üßπ Limpiar Marcadores</button>
        </div>
    </div>
    
    <div id="map"></div>

    <!-- Modal para datos -->
    <div id="dataModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 style="color: #2c3e50; margin-bottom: 20px;">üìç Datos Geot√©cnicos</h2>
            
            <div class="coord-info">
                <h4>Coordenadas del Punto</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; font-family: monospace;">
                    <div><strong>Latitud:</strong> <span id="coordLat">-</span></div>
                    <div><strong>Longitud:</strong> <span id="coordLng">-</span></div>
                    <div><strong>UTM X:</strong> <span id="coordUtmX">-</span></div>
                    <div><strong>UTM Y:</strong> <span id="coordUtmY">-</span></div>
                </div>
            </div>

            <form id="geoForm">
                <div class="form-group">
                    <label>Nombre del T√©cnico/Investigador:</label>
                    <input type="text" id="nombreTecnico" required placeholder="Ingrese su nombre completo">
                </div>
                
                <div class="form-group">
                    <label>Tipo de Suelo (SUCS):</label>
                    <select id="tipoSuelo" required>
                        <option value="">Seleccione...</option>
                        <option value="GW">GW - Grava bien graduada</option>
                        <option value="GP">GP - Grava mal graduada</option>
                        <option value="GM">GM - Grava limosa</option>
                        <option value="GC">GC - Grava arcillosa</option>
                        <option value="SW">SW - Arena bien graduada</option>
                        <option value="SP">SP - Arena mal graduada</option>
                        <option value="SM">SM - Arena limosa</option>
                        <option value="SC">SC - Arena arcillosa</option>
                        <option value="ML">ML - Limo baja plasticidad</option>
                        <option value="CL">CL - Arcilla baja plasticidad</option>
                        <option value="MH">MH - Limo alta plasticidad</option>
                        <option value="CH">CH - Arcilla alta plasticidad</option>
                        <option value="OL">OL - Limo org√°nico</option>
                        <option value="OH">OH - Arcilla org√°nica</option>
                        <option value="PT">PT - Turba</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Profundidad de Muestra (m):</label>
                    <input type="number" id="profundidad" step="0.1" min="0" max="50" required placeholder="Ej: 1.5">
                </div>

                <div class="form-group">
                    <label>Radio de Influencia del Suelo (m):</label>
                    <select id="radioBuffer" required>
                        <option value="">Seleccione radio...</option>
                        <option value="50">50m - Zona muy localizada</option>
                        <option value="100">100m - Zona peque√±a</option>
                        <option value="200">200m - Zona media</option>
                        <option value="500">500m - Zona amplia</option>
                        <option value="1000">1000m - Zona extensa</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>√çndice de Plasticidad (%):</label>
                    <input type="number" id="plasticidad" step="0.1" min="0" max="100" placeholder="Opcional">
                </div>

                <div class="form-group">
                    <label>Nivel Fre√°tico (m):</label>
                    <input type="number" id="freatico" step="0.1" min="0" placeholder="Opcional">
                </div>

                <div class="form-group">
                    <label>Provincia:</label>
                    <select id="provincia" required>
                        <option value="">Seleccione...</option>
                        <option value="Azuay">Azuay</option>
                        <option value="Bol√≠var">Bol√≠var</option>
                        <option value="Ca√±ar">Ca√±ar</option>
                        <option value="Carchi">Carchi</option>
                        <option value="Chimborazo">Chimborazo</option>
                        <option value="Cotopaxi">Cotopaxi</option>
                        <option value="El Oro">El Oro</option>
                        <option value="Esmeraldas">Esmeraldas</option>
                        <option value="Gal√°pagos">Gal√°pagos</option>
                        <option value="Guayas">Guayas</option>
                        <option value="Imbabura">Imbabura</option>
                        <option value="Loja">Loja</option>
                        <option value="Los R√≠os">Los R√≠os</option>
                        <option value="Manab√≠">Manab√≠</option>
                        <option value="Morona Santiago">Morona Santiago</option>
                        <option value="Napo">Napo</option>
                        <option value="Orellana">Orellana</option>
                        <option value="Pastaza">Pastaza</option>
                        <option value="Pichincha">Pichincha</option>
                        <option value="Santa Elena">Santa Elena</option>
                        <option value="Santo Domingo">Santo Domingo</option>
                        <option value="Sucumb√≠os">Sucumb√≠os</option>
                        <option value="Tungurahua">Tungurahua</option>
                        <option value="Zamora Chinchipe">Zamora Chinchipe</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Cant√≥n:</label>
                    <select id="canton" required>
                        <option value="">Seleccione primero la provincia...</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Direcci√≥n:</label>
                    <input type="text" id="direccion" placeholder="Ingrese la direcci√≥n del punto">
                </div>

                <div class="form-group">
                    <label>Observaciones:</label>
                    <textarea id="observaciones" rows="3" placeholder="Informaci√≥n adicional (opcional)"></textarea>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 25px;">
                    <button type="submit" class="btn" style="flex: 1;">üíæ Guardar Datos</button>
                    <button type="button" class="btn" id="cancelBtn" style="flex: 1; background: #95a5a6;">‚ùå Cancelar</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script>
        // Configuraci√≥n
        const SUPABASE_URL = 'https://xgywnwvvrtfoltkcxfgc.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhneXdud3Z2cnRmb2x0a2N4ZmdjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTI2OTUzMTIsImV4cCI6MjA2ODI3MTMxMn0.RNrfIZsgGwZJ8cnKmF26u0kKtoA7n3HAMjda1Wd-EmY';

        // Variables globales
        let map, supabase;
        let isAddingData = false;
        let currentMarker = null;
        let currentBuffer = null;
        let selectedCoords = null;
        let dataMarkers = [];
        let layers = {};

        // Datos para selectores
        const cantonesPorProvincia = {
            'Azuay': ['Cuenca', 'Gir√≥n', 'Gualaceo', 'Nab√≥n', 'Paute', 'Pucar√°', 'San Fernando', 'Santa Isabel', 'Sigsig', 'O√±a', 'Chordeleg', 'El Pan', 'Sevilla de Oro', 'Guachapala', 'Camilo Ponce Enr√≠quez'],
            'Bol√≠var': ['Guaranda', 'Chillanes', 'Chimbo', 'Echeand√≠a', 'Las Naves', 'Caluma', 'San Miguel'],
            'Ca√±ar': ['Azogues', 'Bibli√°n', 'Ca√±ar', 'La Troncal', 'El Tambo', 'D√©leg', 'Suscal'],
            'Carchi': ['Tulc√°n', 'Bol√≠var', 'Espejo', 'Mira', 'Mont√∫far', 'San Pedro de Huaca'],
            'Chimborazo': ['Riobamba', 'Alaus√≠', 'Colta', 'Chambo', 'Chunchi', 'Guamote', 'Guano', 'Pallatanga', 'Penipe', 'Cumand√°'],
            'Cotopaxi': ['Latacunga', 'La Man√°', 'Pangua', 'Pujil√≠', 'Salcedo', 'Saquisil√≠', 'Sigchos'],
            'El Oro': ['Machala', 'Arenillas', 'Atahualpa', 'Balsas', 'Chilla', 'El Guabo', 'Huaquillas', 'Las Lajas', 'Marcabel√≠', 'Pasaje', 'Pi√±as', 'Portovelo', 'Santa Rosa', 'Zaruma'],
            'Esmeraldas': ['Esmeraldas', 'Eloy Alfaro', 'Muisne', 'Quinind√©', 'San Lorenzo', 'Atacames', 'Rioverde', 'La Concordia'],
            'Gal√°pagos': ['San Crist√≥bal', 'Isabela', 'Santa Cruz'],
            'Guayas': ['Guayaquil', 'Alfredo Baquerizo Moreno', 'Balao', 'Balzar', 'Colimes', 'Daule', 'Dur√°n', 'El Empalme', 'El Triunfo', 'Milagro', 'Naranjal', 'Naranjito', 'Palestina', 'Pedro Carbo', 'Samborond√≥n', 'Santa Luc√≠a', 'Salitre', 'San Jacinto de Yaguachi', 'Playas', 'Sim√≥n Bol√≠var', 'Coronel Marcelino Maridue√±a', 'Lomas de Sargentillo', 'Nobol', 'General Antonio Elizalde', 'Isidro Ayora'],
            'Imbabura': ['Ibarra', 'Antonio Ante', 'Cotacachi', 'Otavalo', 'Pimampiro', 'San Miguel de Urcuqu√≠'],
            'Loja': ['Loja', 'Calvas', 'Catamayo', 'Celica', 'Chaguarpamba', 'Esp√≠ndola', 'Gonzanam√°', 'Macar√°', 'Paltas', 'Pindal', 'Puyango', 'Saraguro', 'Sozoranga', 'Zapotillo', 'Paquisha', 'Olmedo'],
            'Los R√≠os': ['Babahoyo', 'Baba', 'Montalvo', 'Puebloviejo', 'Quevedo', 'Urdaneta', 'Ventanas', 'V√≠nces', 'Palenque', 'Buena F√©', 'Valencia', 'Mocache', 'Quinsaloma'],
            'Manab√≠': ['Portoviejo', 'Bol√≠var', 'Chone', 'El Carmen', 'Flavio Alfaro', 'Jipijapa', 'Jun√≠n', 'Manta', 'Montecristi', 'Paj√°n', 'Pichincha', 'Rocafuerte', 'Santa Ana', 'Sucre', 'Tosagua', 'Veinticuatro de Mayo', 'Pedernales', 'Olmedo', 'Puerto L√≥pez', 'Jama', 'Jaramij√≥', 'San Vicente'],
            'Morona Santiago': ['Morona', 'Gualaquiza', 'Lim√≥n Indanza', 'Palora', 'Santiago', 'Suc√∫a', 'Huamboya', 'San Juan Bosco', 'Taisha', 'Logro√±o', 'Pablo Sexto', 'Tiwintza'],
            'Napo': ['Tena', 'Archidona', 'El Chaco', 'Quijos', 'Carlos Julio Arosemena Tola'],
            'Orellana': ['Francisco de Orellana', 'Aguarico', 'La Joya de los Sachas', 'Loreto'],
            'Pastaza': ['Puyo', 'Arajuno', 'Mera', 'Santa Clara'],
            'Pichincha': ['Quito', 'Cayambe', 'Mej√≠a', 'Pedro Moncayo', 'Rumi√±ahui', 'San Miguel de los Bancos', 'Pedro Vicente Maldonado', 'Puerto Quito'],
            'Santa Elena': ['Santa Elena', 'La Libertad', 'Salinas'],
            'Santo Domingo': ['Santo Domingo'],
            'Sucumb√≠os': ['Lago Agrio', 'Gonzalo Pizarro', 'Putumayo', 'Shushufindi', 'Sucumb√≠os', 'Cascales', 'Cuyabeno'],
            'Tungurahua': ['Ambato', 'Ba√±os de Agua Santa', 'Cevallos', 'Mocha', 'Patate', 'Pelileo', 'P√≠llaro', 'Quero', 'Tisaleo'],
            'Zamora Chinchipe': ['Zamora', 'Chinchipe', 'Nangaritza', 'Yacuambi', 'Yantzaza', 'El Pangui', 'Centinela del C√≥ndor', 'Palanda', 'Paquisha']
        };

        // Funci√≥n UTM
        function toUTM(lat, lng) {
            const x = Math.round((lng + 81) * 111320 * Math.cos(lat * Math.PI / 180) + 500000);
            const y = Math.round(Math.abs(lat * 110540) + 10000000);
            return { x, y };
        }

        function updateStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        // Inicializaci√≥n
        window.onload = function() {
            updateStatus('Iniciando mapa...', 'warning');
            
            try {
                // Inicializar Supabase
                supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
                
                // Crear mapa
                map = L.map('map').setView([-2.9001, -79.0059], 10);
                
                // Agregar capa base
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);
                
                updateStatus('Mapa cargado correctamente', 'success');
                
                // Cargar capas autom√°ticamente
                setTimeout(() => {
                    loadLayer('cantones');
                    loadLayer('parroquias');
                }, 1000);
                
                // Eventos
                setupEvents();
                
            } catch (error) {
                console.error('Error inicializando:', error);
                updateStatus('Error: ' + error.message, 'error');
            }
        };

        function setupEvents() {
            // Botones principales
            document.getElementById('btnAddData').onclick = toggleAddData;
            document.getElementById('btnShowData').onclick = showData;
            document.getElementById('btnClear').onclick = clearMarkers;
            
            // Modal
            document.querySelector('.close').onclick = closeModal;
            document.getElementById('cancelBtn').onclick = closeModal;
            document.getElementById('geoForm').onsubmit = saveData;
            document.getElementById('radioBuffer').onchange = createBuffer;
            
            // Selectores de ubicaci√≥n
            document.getElementById('provincia').onchange = function() {
                const canton = document.getElementById('canton');
                
                canton.innerHTML = '<option value="">Seleccione cant√≥n...</option>';
                
                if (cantonesPorProvincia[this.value]) {
                    cantonesPorProvincia[this.value].forEach(c => {
                        canton.innerHTML += `<option value="${c}">${c}</option>`;
                    });
                }
            };
            
            document.getElementById('canton').onchange = function() {
                // Ya no necesita llenar parroquias
            };
            
            // Capas
            document.querySelectorAll('input[id^="layer-"]').forEach(cb => {
                cb.onchange = function() {
                    const layerName = this.id.replace('layer-', '');
                    if (this.checked) {
                        loadLayer(layerName);
                    } else {
                        removeLayer(layerName);
                    }
                };
            });
            
            // Clic en mapa
            map.on('click', onMapClick);
            
            // Cerrar modal con clic fuera
            window.onclick = function(event) {
                if (event.target === document.getElementById('dataModal')) {
                    closeModal();
                }
            };
        }

        async function loadLayer(layerName) {
            if (layers[layerName]) return;
            
            const tableNames = {
                'cantones': 'CANTONESDELAZUAY',
                'parroquias': 'parroquiasazuay',
                'edificios': 'edificios',
                'vias': 'vias cuenca',
                'usos': 'usos de suelo'
            };
            
            const tableName = tableNames[layerName];
            if (!tableName) return;
            
            try {
                updateStatus(`Cargando ${layerName}...`, 'warning');
                
                const { data, error } = await supabase.from(tableName).select('*');
                
                if (error) {
                    console.error(`Error cargando ${tableName}:`, error);
                    updateStatus(`Error en ${layerName}`, 'error');
                    return;
                }
                
                if (data && data.length > 0) {
                    const layerGroup = L.layerGroup();
                    let count = 0;
                    
                    data.forEach(item => {
                        // Buscar campo de geometr√≠a
                        let geomField = null;
                        for (const key in item) {
                            if (key.toLowerCase().includes('geom')) {
                                geomField = key;
                                break;
                            }
                        }
                        
                        if (geomField && item[geomField]) {
                            try {
                                const geom = typeof item[geomField] === 'string' 
                                    ? JSON.parse(item[geomField]) 
                                    : item[geomField];
                                
                                const layer = L.geoJSON(geom, {
                                    style: getLayerStyle(layerName),
                                    onEachFeature: function(feature, layer) {
                                        let popupContent = `<h4 style="margin: 0 0 10px 0; color: #2c3e50;">${tableName}</h4>`;
                                        Object.keys(item).forEach(key => {
                                            if (!key.toLowerCase().includes('geom') && item[key]) {
                                                popupContent += `<p style="margin: 3px 0;"><strong>${key}:</strong> ${item[key]}</p>`;
                                            }
                                        });
                                        layer.bindPopup(popupContent);
                                    }
                                });
                                
                                layerGroup.addLayer(layer);
                                count++;
                            } catch (e) {
                                console.warn('Error parseando geometr√≠a:', e);
                            }
                        }
                    });
                    
                    if (count > 0) {
                        layers[layerName] = layerGroup;
                        layerGroup.addTo(map);
                        updateStatus(`${layerName} cargado (${count} elementos)`, 'success');
                    } else {
                        updateStatus(`${layerName}: sin geometr√≠as v√°lidas`, 'warning');
                    }
                } else {
                    updateStatus(`${layerName}: tabla vac√≠a`, 'warning');
                }
                
            } catch (error) {
                console.error(`Error cargando ${layerName}:`, error);
                updateStatus(`Error en ${layerName}`, 'error');
            }
        }

        function removeLayer(layerName) {
            if (layers[layerName]) {
                map.removeLayer(layers[layerName]);
                delete layers[layerName];
            }
        }

        function getLayerStyle(layerName) {
            const styles = {
                'cantones': { color: '#e74c3c', weight: 2, fillOpacity: 0.1 },
                'parroquias': { color: '#3498db', weight: 1, fillOpacity: 0.1 },
                'edificios': { color: '#f39c12', weight: 1, fillOpacity: 0.3 },
                'vias': { color: '#9b59b6', weight: 3, fillOpacity: 0 },
                'usos': { color: '#1abc9c', weight: 1, fillOpacity: 0.2 }
            };
            return styles[layerName] || { color: '#34495e', weight: 1, fillOpacity: 0.1 };
        }

        function toggleAddData() {
            isAddingData = !isAddingData;
            const btn = document.getElementById('btnAddData');
            
            if (isAddingData) {
                btn.textContent = '‚ùå Cancelar Ingreso';
                btn.classList.add('active');
                map.getContainer().style.cursor = 'crosshair';
                updateStatus('Haz clic en el mapa para agregar punto', 'warning');
            } else {
                btn.textContent = 'üìç Ingresar Datos';
                btn.classList.remove('active');
                map.getContainer().style.cursor = '';
                updateStatus('Modo ingreso desactivado', 'success');
                if (currentMarker) map.removeLayer(currentMarker);
                if (currentBuffer) map.removeLayer(currentBuffer);
            }
        }

        function onMapClick(e) {
            if (!isAddingData) return;
            
            selectedCoords = e.latlng;
            
            if (currentMarker) map.removeLayer(currentMarker);
            if (currentBuffer) map.removeLayer(currentBuffer);
            
            currentMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
            
            const utm = toUTM(e.latlng.lat, e.latlng.lng);
            
            document.getElementById('coordLat').textContent = e.latlng.lat.toFixed(6);
            document.getElementById('coordLng').textContent = e.latlng.lng.toFixed(6);
            document.getElementById('coordUtmX').textContent = utm.x;
            document.getElementById('coordUtmY').textContent = utm.y;
            
            document.getElementById('dataModal').style.display = 'block';
        }

        function createBuffer() {
            const radius = document.getElementById('radioBuffer').value;
            if (!radius || !selectedCoords) return;
            
            if (currentBuffer) map.removeLayer(currentBuffer);
            
            currentBuffer = L.circle([selectedCoords.lat, selectedCoords.lng], {
                radius: parseInt(radius),
                color: '#3498db',
                fillColor: '#3498db',
                fillOpacity: 0.2,
                weight: 2,
                dashArray: '5, 5'
            }).addTo(map);
            
            currentBuffer.bindPopup(`
                <div style="text-align: center;">
                    <h4>üéØ √Årea de Influencia</h4>
                    <p><strong>Radio:</strong> ${radius} metros</p>
                    <p><strong>√Årea:</strong> ${(Math.PI * Math.pow(radius, 2) / 10000).toFixed(2)} hect√°reas</p>
                </div>
            `);
        }

        async function saveData(e) {
            e.preventDefault();
            
            if (!selectedCoords) {
                alert('No hay coordenadas seleccionadas');
                return;
            }
            
            try {
                updateStatus('Guardando datos...', 'warning');
                
                const utm = toUTM(selectedCoords.lat, selectedCoords.lng);
                
                const data = {
                    nombre_tecnico: document.getElementById('nombreTecnico').value,
                    latitud: selectedCoords.lat,
                    longitud: selectedCoords.lng,
                    utm_x: utm.x,
                    utm_y: utm.y,
                    tipo_suelo_sucs: document.getElementById('tipoSuelo').value,
                    profundidad_muestra: parseFloat(document.getElementById('profundidad').value),
                    radio_influencia: parseInt(document.getElementById('radioBuffer').value),
                    indice_plasticidad: parseFloat(document.getElementById('plasticidad').value) || null,
                    nivel_freatico: parseFloat(document.getElementById('freatico').value) || null,
                    provincia: document.getElementById('provincia').value,
                    canton: document.getElementById('canton').value,
                    direccion: document.getElementById('direccion').value,
                    observaciones: document.getElementById('observaciones').value || null,
                    fecha_registro: new Date().toISOString()
                };
                
                const { error } = await supabase.from('datos_geotecnicos').insert([data]);
                
                if (error) {
                    if (error.code === '42P01') {
                        alert('CREAR TABLA EN PGADMIN:\n\nCREATE TABLE datos_geotecnicos (\n  id SERIAL PRIMARY KEY,\n  nombre_tecnico VARCHAR(100),\n  latitud DOUBLE PRECISION,\n  longitud DOUBLE PRECISION,\n  utm_x INTEGER,\n  utm_y INTEGER,\n  tipo_suelo_sucs VARCHAR(10),\n  profundidad_muestra DECIMAL(5,2),\n  radio_influencia INTEGER,\n  indice_plasticidad DECIMAL(5,2),\n  nivel_freatico DECIMAL(10,2),\n  provincia VARCHAR(50),\n  canton VARCHAR(50),\n  direccion TEXT,\n  observaciones TEXT,\n  fecha_registro TIMESTAMP DEFAULT CURRENT_TIMESTAMP\n);');
                        updateStatus('Tabla no existe - Ver instrucciones', 'error');
                        return;
                    }
                    throw error;
                }
                
                updateStatus('Datos guardados exitosamente', 'success');
                alert('‚úÖ Datos guardados correctamente');
                closeModal();
                
            } catch (error) {
                console.error('Error guardando:', error);
                updateStatus('Error: ' + error.message, 'error');
                alert('‚ùå Error: ' + error.message);
            }
        }

        async function showData() {
            try {
                updateStatus('Cargando datos existentes...', 'warning');
                
                const { data, error } = await supabase
                    .from('datos_geotecnicos')
                    .select('*')
                    .order('fecha_registro', { ascending: false });
                
                if (error) {
                    if (error.code === '42P01') {
                        alert('No hay tabla de datos a√∫n. Crea la tabla primero.');
                        updateStatus('Tabla no existe', 'warning');
                        return;
                    }
                    throw error;
                }
                
                clearMarkers();
                
                if (data && data.length > 0) {
                    data.forEach((punto, i) => {
                        // Marcador principal
                        const marker = L.marker([punto.latitud, punto.longitud])
                            .bindPopup(`
                                <div style="max-width: 300px;">
                                    <h4 style="margin: 0 0 10px 0; color: #2c3e50;">üìä Punto Geot√©cnico ${i + 1}</h4>
                                    <p><strong>üë§ T√©cnico:</strong> ${punto.nombre_tecnico}</p>
                                    <p><strong>üèóÔ∏è Suelo:</strong> ${punto.tipo_suelo_sucs}</p>
                                    <p><strong>üìè Profundidad:</strong> ${punto.profundidad_muestra}m</p>
                                    <p><strong>üéØ Radio:</strong> ${punto.radio_influencia}m</p>
                                    <p><strong>üìà Plasticidad:</strong> ${punto.indice_plasticidad || 'N/A'}%</p>
                                    <p><strong>üíß Fre√°tico:</strong> ${punto.nivel_freatico || 'N/A'}m</p>
                                    <p><strong>üìç Ubicaci√≥n:</strong> ${punto.direccion || 'Sin direcci√≥n'}, ${punto.canton}</p>
                                    <p><strong>üìÖ Fecha:</strong> ${new Date(punto.fecha_registro).toLocaleDateString()}</p>
                                    ${punto.observaciones ? `<p><strong>üìù Obs:</strong> ${punto.observaciones}</p>` : ''}
                                </div>
                            `)
                            .addTo(map);
                        
                        dataMarkers.push(marker);
                        
                        // Buffer del √°rea de influencia
                        if (punto.radio_influencia) {
                            const buffer = L.circle([punto.latitud, punto.longitud], {
                                radius: punto.radio_influencia,
                                color: '#27ae60',
                                fillColor: '#27ae60',
                                fillOpacity: 0.15,
                                weight: 2,
                                dashArray: '3, 3'
                            }).addTo(map);
                            
                            buffer.bindPopup(`
                                <div style="text-align: center;">
                                    <h4>üéØ √Årea de Influencia</h4>
                                    <p><strong>Suelo:</strong> ${punto.tipo_suelo_sucs}</p>
                                    <p><strong>Radio:</strong> ${punto.radio_influencia}m</p>
                                    <p><strong>T√©cnico:</strong> ${punto.nombre_tecnico}</p>
                                </div>
                            `);
                            
                            dataMarkers.push(buffer);
                        }
                    });
                    
                    updateStatus(`${data.length} puntos cargados con √©xito`, 'success');
                    alert(`‚úÖ Se cargaron ${data.length} puntos geot√©cnicos en el mapa`);
                    
                    // Ajustar vista del mapa
                    if (data.length > 0) {
                        const group = new L.featureGroup(dataMarkers.filter(m => m instanceof L.Marker));
                        map.fitBounds(group.getBounds().pad(0.1));
                    }
                    
                } else {
                    updateStatus('No hay datos para mostrar', 'warning');
                    alert('‚ÑπÔ∏è No hay datos geot√©cnicos guardados');
                }
                
            } catch (error) {
                console.error('Error cargando datos:', error);
                updateStatus('Error cargando datos', 'error');
                alert('‚ùå Error cargando datos: ' + error.message);
            }
        }

        function clearMarkers() {
            dataMarkers.forEach(marker => map.removeLayer(marker));
            dataMarkers = [];
            updateStatus('Marcadores eliminados', 'success');
        }

        function closeModal() {
            document.getElementById('dataModal').style.display = 'none';
            document.getElementById('geoForm').reset();
            
            if (currentMarker) {
                map.removeLayer(currentMarker);
                currentMarker = null;
            }
            
            if (currentBuffer) {
                map.removeLayer(currentBuffer);
                currentBuffer = null;
            }
            
            if (isAddingData) toggleAddData();
            selectedCoords = null;
        }

        console.log('üó∫Ô∏è Geoportal Azuay cargado y listo para usar');
    </script>
</body>
</html>
